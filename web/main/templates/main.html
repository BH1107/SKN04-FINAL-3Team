<!DOCTYPE html>
<html lang="en">
<head>
    {% load static %}
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <title>Styled Layout</title>
    <link rel="stylesheet" href="{% static 'css/main.css' %}">
</head>
<body>
    <!-- ÌîÑÎ°úÌïÑ ÏÑπÏÖò -->
    <!-- ÌÅ¥Î¶≠ Ïãú Ïù¥Îèô: id="profileLink" -->
    <div class="profile-section">
        <img class="nav-icon" id="nav-icon"
                data-light="{% static 'images/nav/nav_profile_light.png' %}" 
                data-dark="{% static 'images/nav/nav_profile_dark.png' %}" 
                src="{% static 'images/nav/nav_profile_light.png' %}" 
                style="width: 35px; height: 35px; cursor: pointer;">
        <span id="profileLink">
            {% if user.is_authenticated %}
                {{ user.username }}
            {% else %}
                Sign In
            {% endif %}
        </span>

        <!-- ÌåùÏóÖÏ∞Ω -->
        {% if user.is_authenticated %}
        <div id="profilePopup" class="popup hidden">
            <ul>
                <li><a href="/app/chatting/">Chattings</a></li>
                <li><a href="/app/favorites/">Bookmark</a></li>
                <li><a href="/app/settings/">Settings</a></li>
                <li><a href="/app/profile/">Profile</a></li>
            </ul>
        </div>
        {% endif %}
    </div>

    <!-- Î©îÏù∏ Ïª®ÌÖåÏù¥ÎÑà -->
    <div class="container">
        <!-- ÌÉÄÏù¥ÌãÄ -->
        <div class="title">SeouLOGUE</div>

        <!-- ÏûÖÎ†• ÏÑπÏÖò -->
        <div class="input-wrapper">
            <!-- ÌÖçÏä§Ìä∏ ÏûÖÎ†•ÎûÄ -->
            <textarea 
                class="input-box" 
                placeholder="ÏùºÏ†ïÏùÑ ÎßåÎì§Í±∞ÎÇò Ïû•ÏÜåÎ•º Í≤ÄÏÉâÌï¥ Î≥¥ÏÑ∏Ïöî"
                rows="2"
                maxlength="2000"
            ></textarea>
            <!-- Í≤ÄÏùÄÏÉâ Î≤ÑÌäº -->
            <button class="send-button" onclick="goToEnterPage()">üîç</button>
        </div>
    </div>

    <!-- (A) DjangoÏóêÏÑú Î°úÍ∑∏Ïù∏ Ïó¨Î∂ÄÎ•º JS Î≥ÄÏàòÎ°ú ÎÑòÍπÄ -->
    <script>
        // user.is_authenticatedÎäî True ÎòêÎäî FalseÎ•º ÌååÏù¥Ïç¨ Î∂ÄÏö∏ÌòïÏúºÎ°ú Í∞ÄÏßÄÎØÄÎ°ú,
        // ÌÖúÌîåÎ¶ø ÌïÑÌÑ∞ yesno:"true,false"Î•º ÏÇ¨Ïö©Ìï¥ JSÏóêÏÑú Ïì∏ Ïàò ÏûàÎèÑÎ°ù Î≥ÄÌôò
        const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};

        // (B) "My Profile" ÌÅ¥Î¶≠ Ïãú Ï≤òÎ¶¨
        document.addEventListener('DOMContentLoaded', function() {
            const popup = document.getElementById('profilePopup');
            const navicon = document.getElementById('nav-icon');
            const profileLink = document.getElementById('profileLink');

            if (navicon) {
                navicon.addEventListener('click', function(e) {
                    if (isLoggedIn) {
                        // Î°úÍ∑∏Ïù∏Ïù¥ ÎêòÏñ¥ ÏûàÎã§Î©¥ ÌåùÏóÖÏ∞Ω Ïó¥Í∏∞
                        e.stopPropagation(); // Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
                        popup.classList.toggle('hidden');                        
                        // window.location.href = "/app/profile/";
                    } else {
                        // Ïïà ÎêòÏñ¥ ÏûàÎã§Î©¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                        window.location.href = "/login/";
                    }
                });
            }
            if (profileLink) {
                profileLink.addEventListener('click', function(e) {
                    if (isLoggedIn) {
                        // Î°úÍ∑∏Ïù∏Ïù¥ ÎêòÏñ¥ ÏûàÎã§Î©¥ ÌåùÏóÖÏ∞Ω Ïó¥Í∏∞
                        e.stopPropagation(); // Ïù¥Î≤§Ìä∏ Î≤ÑÎ∏îÎßÅ Î∞©ÏßÄ
                        popup.classList.toggle('hidden');                        
                        // window.location.href = "/app/profile/";
                    } else {
                        // Ïïà ÎêòÏñ¥ ÏûàÎã§Î©¥ Î°úÍ∑∏Ïù∏ ÌéòÏù¥ÏßÄÎ°ú Ïù¥Îèô
                        window.location.href = "/login/";
                    }
                });

                // ÌåùÏóÖ Ïô∏Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´Í∏∞
                document.addEventListener('click', function (e) {
                    if (popup) {
                        if (!popup.classList.contains('hidden')) {
                            popup.classList.add('hidden');
                        }
                    }                    
                });

                if (popup) {
                    // ÌåùÏóÖ ÎÇ¥Î∂Ä ÌÅ¥Î¶≠ Ïãú Îã´ÌûàÏßÄ ÏïäÏùå
                    popup.addEventListener('click', function (e) {
                        e.stopPropagation();
                    });
                }                
            }
        });

        async function goToEnterPage() {
            const inputBox = document.querySelector('.input-box');
            const userInput = inputBox.value.trim();

            if (userInput === "") {
                alert("ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî!");
                return;
            }

            localStorage.setItem("chatMessage", userInput);

            if (isLoggedIn) {
                // Î°úÍ∑∏Ïù∏Ìïú ÏÇ¨Ïö©ÏûêÏùº Í≤ΩÏö∞ chat_id Í∞ÄÏ†∏Ïò§Í∏∞
                try {
                    const response = await fetch("/app/partials/planner/get_or_create_chat_id/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success && data.chat_id) {
                        // chat_idÎ•º URLÏóê Ìè¨Ìï®ÌïòÏó¨ Ïù¥Îèô
                        window.location.href = `/app/planner/?chat_id=${encodeURIComponent(data.chat_id)}`;
                    } else {
                        console.error("Failed to get chat_id:", data.error || "Unknown error");
                        alert("chat_idÎ•º Í∞ÄÏ†∏Ïò§Îäî Îç∞ Ïã§Ìå®ÌñàÏäµÎãàÎã§.");
                    }
                } catch (error) {
                    console.error("Error fetching chat_id:", error);
                    alert("chat_idÎ•º Í∞ÄÏ†∏Ïò§Îäî ÎèÑÏ§ë Ïò§Î•òÍ∞Ä Î∞úÏÉùÌñàÏäµÎãàÎã§.");
                }
            } else {
                // ÎπÑÎ°úÍ∑∏Ïù∏ ÏÇ¨Ïö©ÏûêÏùº Í≤ΩÏö∞
                window.location.href = `/app/planner/?chatMessage=${encodeURIComponent(userInput)}`;
            }
        }

        // ÏûÖÎ†•Ï∞Ω ÏûêÎèô ÎÜíÏù¥ Ï°∞Ï†ï Î∞è Î≤ÑÌäº ÏúÑÏπò Ïú†ÏßÄ
        document.querySelector('.input-box').addEventListener('input', function () {
            this.style.height = "auto";
            const scrollHeight = this.scrollHeight;
            const maxHeight = 300; // 6Ï§Ñ ÎÜíÏù¥ Ï†úÌïú
            this.style.height = `${Math.min(scrollHeight, maxHeight)}px`;

            if (scrollHeight > maxHeight) {
                this.style.overflowY = "scroll";
            } else {
                this.style.overflowY = "hidden";
            }
        });

        // Enter Î∞è Shift+Enter Ï≤òÎ¶¨
        document.querySelector('.input-box').addEventListener('keydown', function (e) {
            if (e.key === "Enter" && e.shiftKey) {
                e.preventDefault();
                const cursorPosition = this.selectionStart;
                this.value = this.value.slice(0, cursorPosition) + "\n" + this.value.slice(cursorPosition);
            } else if (e.key === "Enter") {
                e.preventDefault();
                document.querySelector('.send-button').click();
            }
        });

        function getCSRFToken() {
            const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');
            return csrfToken;
        }
    </script>
</body>
</html>
