<!-- spa_base.html -->
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SPA Example</title>
    {% load static %}
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body data-theme="{% if settings.is_white_theme %}light{% else %}dark{% endif %}">
    <div class="container">
        <div class="sidebar" id="sidebar">
            <button class="nav-btn" id="home-btn">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_home_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_home_dark.png' %}" 
                     src="{% static 'images/nav/nav_home_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Home
            </button>
            <button class="nav-btn" data-url="/app/planner/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_planner_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_planner_dark.png' %}" 
                     src="{% static 'images/nav/nav_planner_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Planner
            </button>
            <button class="nav-btn" data-url="/app/chatting/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_chattings_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_chattings_dark.png' %}" 
                     src="{% static 'images/nav/nav_chattings_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Chatting
            </button>
            <button class="nav-btn" data-url="/app/favorites/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_favorites_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_favorites_dark.png' %}" 
                     src="{% static 'images/nav/nav_favorites_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Bookmarks
            </button>
            <button class="nav-btn" data-url="/app/settings/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_settings_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_settings_dark.png' %}" 
                     src="{% static 'images/nav/nav_settings_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Settings
            </button>
            <button class="nav-btn" data-url="/app/profile/">
                <img class="nav-icon" data-light="{% static 'images/nav/nav_profile_light.png' %}" 
                     data-dark="{% static 'images/nav/nav_profile_dark.png' %}" 
                     src="{% static 'images/nav/nav_profile_light.png' %}" 
                     style="width: 30px; height: 30px;">
                <br>Profile
            </button>
        </div>

        <!-- 동적 콘텐츠 영역 -->
        <div id="content1">            
            <!-- AJAX로 불러온 partial HTML이 여기 들어감 -->
        </div>
        <!-- 지도 영역 -->
        <div id="map-container">
            <div id="map"></div>
            <div id="map-panel">
                <div id="drag-handle"></div> <!-- 드래그 핸들 추가 -->
                <div id="button-panel">
                    <strong id="panel-title"></strong>
                    <div class="button-group">
                        <button id="removeContentBtn" onclick="removeContent()">🗑️</button>
                        <button id="getBookmarkListBtn" onclick="getBookmarkList()">☆</button>
                        <button id="toggleUIBtn" onclick="toggleMapPanel()">⮟</button>
                    </div>
                </div> 
                <div class="map-panel-content">
                </div>
            </div>
        </div>
    </div>

    <!-- 새로운 애니메이션용 DIV -->
    <div id="bookmarklist-div">
        <div style="display: flex; justify-content: flex-end; align-items: flex-end;">
            <button id="closeBookmarkListBtn" onclick="document.querySelector('#bookmarklist-div').classList.remove('active');">∨</button>
        </div>
        <div class="bookmarklist-panel">
            <div style="text-align: center; margin-bottom: 40px;">
                <h2 style="text-align: center; margin: 0; margin-bottom: 10px;">Edit this title</h2>
                <h3 style="display: none;"></h3>
                <input id="change-title" type="text" style="display: none; margin: 0 auto; margin-bottom: 10px;" maxlength="20">
                <h6 style="text-align: center; margin: 0;">(Double click the title to edit)</h6>
            </div>
            <ul>

            </ul>
        </div>
    </div>

    <!-- 팝업 창 -->
    <div id="popup" class="popup hidden">
        <div class="popup-content">
            <h3>Are you sure you want to delete your account?</h3>
            <div class="popup-buttons">
                <button id="confirm-delete" class="popup-button">Yes, Delete</button>
                <button id="cancel-delete" class="popup-button">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        window.onload = function () {
            // localStorage의 특정 키 삭제
            // localStorage.removeItem('chatMessage');

            // 또는 모든 데이터 삭제
            // localStorage.clear();

            // console.log("LocalStorage cleared or specific key removed.");
        };

        const ncpClientId = "{{ ncp_client_id|default:'' }}";
        const ncpClientSecret = "{{ ncp_client_secret|default:'' }}";
        let isMapInitialized = false;
        let map = null;
        let lastLoadedPath = null;
        let globalMarkerData = []; // 전역 변수로 선언
        let isPlaceInputOpen = false;
        let isScheduleInputOpen = false;
        const isLoggedIn = {{ user.is_authenticated|yesno:"true,false" }};

        // ---------------------------
        // (1) 지도 초기화 함수
        // ---------------------------
        function initializeMap(markerData) {
            if (isMapInitialized) return;

            const mapScript = document.createElement('script');
            mapScript.src = `https://openapi.map.naver.com/openapi/v3/maps.js?ncpClientId=${ncpClientId}`;
            mapScript.onload = function () {
                map = new naver.maps.Map('map', {
                    center: new naver.maps.LatLng(37.5296, 126.9644), // 용산역 좌표
                    zoom: 13,
                });
                isMapInitialized = true;

                // 마커 추가
                if (markerData) {
                    markerData.forEach(data => {
                        const marker = new naver.maps.Marker({
                            position: data.position,
                            map: map,
                            title: data.title,
                            icon: {
                                url: data.icon, // 커스텀 마커 이미지 URL
                                size: new naver.maps.Size(36, 36), // 마커 크기
                                origin: new naver.maps.Point(0, 0),
                                anchor: new naver.maps.Point(18, 36), // 마커 위치 조정
                            },
                        });

                        // 정보창 생성
                        // var infoWindow = new naver.maps.InfoWindow({
                        //     content: `<div style="width:200px;text-align:center;padding:10px;">
                        //                 <h4>가맹점 정보</h4>
                        //                 <p>여기에 가맹점 정보를 표시합니다.</p>
                        //             </div>`
                        // });

                        // 마커 클릭 이벤트 (선택 사항)
                        naver.maps.Event.addListener(marker, 'click', function () {
                            alert(`${data.title}입니다!`);
                            // infoWindow.open(map, marker); // 마커 클릭 시 정보창 열기
                        });
                    });

                    // 선 연결
                    for (let i = 0; i < markerData.length - 1; i++) {
                        const polyline = new naver.maps.Polyline({
                            map: map,
                            path: [markerData[i].position, markerData[i + 1].position], // 인접한 마커 연결
                            strokeColor: '#000000', // 선 색상
                            strokeWeight: 0, // 선 두께
                            strokeStyle: 'solid', // 선 스타일 (solid, dashed, dotted 등)
                        });
                    }
                }
            };
            mapScript.onerror = function () {
                console.error("Failed to load Naver Map script.");
            };

            document.head.appendChild(mapScript);
        }

        // ---------------------------
        // (2) /app/* -> /app/partials/* 치환 함수
        // ---------------------------
        function toPartialUrl(spaPath) {
            // 예: /app/planner/ -> /app/partials/planner/
            return spaPath.replace(/^\/app/, '/app/partials');
        }

        // 현재 활성화된 nav-btn 표시 함수
        function highlightActiveLink(spaPath) {
            console.log("highlightActiveLink");
            document.querySelectorAll('.nav-btn').forEach(btn => {
                const url = btn.getAttribute('data-url');
                if (!url) return;  // home-btn이 data-url이 없으므로 건너뜀

                if (url === spaPath) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
        }
        
        function loadContent(spaPath) {
            if (lastLoadedPath === spaPath) {
                console.log("중복된 경로로 로드 중단:", spaPath, ",lastPath:", lastLoadedPath);
                return;
            }

            lastLoadedPath = spaPath;
            const partialUrl = toPartialUrl(spaPath);
            // console.log("Loading content for path:", partialUrl);

            fetch(partialUrl)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    document.getElementById('content1').innerHTML = html;

                    // spaContentLoaded 이벤트 트리거
                    document.dispatchEvent(new Event("spaContentLoaded"));
                })
                .catch(error => console.error('Error loading content:', error));
        }

        function updateIconsBasedOnTheme() {
            const isLightTheme = document.body.getAttribute("data-theme") === "light";
            
            const navIcons = document.querySelectorAll(".nav-icon");
            navIcons.forEach(icon => {
                const newSrc = isLightTheme ? icon.getAttribute("data-light") : icon.getAttribute("data-dark");
                icon.setAttribute("src", newSrc);
            });

            const editIcon = document.querySelector(".edit-icon");
            if (editIcon) {
                const newEditSrc = isLightTheme ? editIcon.getAttribute("data-light") : editIcon.getAttribute("data-dark");
                editIcon.setAttribute("src", newEditSrc);
            }

            const deletePlaceBtns = document.querySelectorAll("#deletePlaceBtn");
            deletePlaceBtns.forEach(button => {
                button.src = isLightTheme ? "/static/images/delete_light.png" : "/static/images/delete_dark.png";
            });
        }

        document.addEventListener("DOMContentLoaded", function () {            
            // 지도 초기화
            initializeMap();
            updateIconsBasedOnTheme();

            let currentPath = window.location.pathname;

            // /app/ 만 입력되었다면 디폴트: /app/planner/ 로 가정
            if (currentPath === '/app/') {
                currentPath = '/app/planner/';
                history.replaceState(null, '', currentPath);
            }
            loadContent(currentPath);

            // 네비게이션 버튼 클릭 시
            document.querySelectorAll('.nav-btn').forEach(button => {
                button.addEventListener('click', function (event) {
                    event.preventDefault();
                    const spaPath = this.getAttribute('data-url'); // 이동하려는 URL

                    if (!spaPath) return; // URL이 없는 경우 무시
                    
                    if (isLoggedIn === false) {
                        // 비로그인 상태일 경우 alert 창 띄우기
                        const confirmLogin = confirm("로그인이 필요한 화면입니다. 로그인하시겠습니까?");
                        if (confirmLogin) {
                            // 확인 버튼을 눌렀을 경우 로그인 페이지로 이동
                            const currentPath = window.location.pathname; // 현재 페이지 경로
                            window.location.href = `/login/?next=${encodeURIComponent(spaPath)}`;
                        }
                        // 취소 버튼을 누르면 아무 일도 하지 않음
                    } else {
                        // 로그인 상태라면 해당 페이지로 이동
                        history.pushState(null, '', spaPath);
                        loadContent(spaPath); // 네비게이션 바의 페이지 로딩
                    }
                });
            });

            // Home 버튼 처리
            const homeButton = document.getElementById('home-btn');
            if (homeButton) {
                document.getElementById('home-btn').addEventListener('click', function () {
                    window.location.href = '/';
                });
            }            

            // 팝업 창 기능
            document.getElementById('cancel-delete').addEventListener('click', closePopup);
            document.getElementById('confirm-delete').addEventListener('click', function () {
                alert('Account deleted!');
                closePopup();
            });

            // 뒤로가기/앞으로가기 처리
            window.addEventListener('popstate', function () {
                loadContent(window.location.pathname);
            });   
            
            const mapPanel = document.getElementById("map-panel");
            const dragHandle = document.getElementById("drag-handle");

            let isDragging = false; // 드래그 상태
            let startY = 0; // 마우스 시작 Y 좌표
            let startHeight = 0; // mapPanel 시작 높이

            // 드래그 시작
            dragHandle.addEventListener("mousedown", function (e) {
                isDragging = true;
                startY = e.clientY; // 마우스 시작 위치 저장
                startHeight = mapPanel.offsetHeight; // mapPanel의 시작 높이 저장

                document.body.style.userSelect = "none"; // 드래그 중 텍스트 선택 방지
            });

            // 드래그 진행
            document.addEventListener("mousemove", function (e) {
                if (!isDragging) return;
                
                const deltaY = e.clientY - startY; // 마우스 이동 거리
                const newHeight = startHeight - deltaY; // 새로운 패널 높이 계산
                
                const maxHeight = window.innerHeight * 9 / 10; // 화면 전체 높이의 90%
                const minHeight = 45; // 최소 높이 제한
                
                if (newHeight >= minHeight && newHeight <= maxHeight) {
                    mapPanel.style.height = `${newHeight}px`; // mapPanel 높이 업데이트

                    // 버튼 텍스트 업데이트
                    const toggleUIBtn = document.getElementById("toggleUIBtn");
                    toggleUIBtn.textContent = newHeight > minHeight ? "⮟" : "⮝";

                    // 버튼 컨테이너 위치 조정
                    const buttonContainer = document.getElementById("day-button-container");
                    if (buttonContainer) {
                        const mapPanelTop = mapPanel.getBoundingClientRect().top;
                        buttonContainer.style.top = `${mapPanelTop - buttonContainer.offsetHeight - 15}px`;
                    }
                }
                else if (newHeight < minHeight) {
                    mapPanel.style.height = `45px`;

                    const toggleUIBtn = document.getElementById("toggleUIBtn");
                    toggleUIBtn.textContent = "⮝";
                }
            });

            // 드래그 종료
            document.addEventListener("mouseup", function () {
                if (isDragging) {
                    isDragging = false;
                    document.body.style.userSelect = ""; // 텍스트 선택 복구
                }
            });        
        });
        
        function getCSRFToken() {
            const cookies = document.cookie.split("; ");
            for (let cookie of cookies) {
                if (cookie.startsWith("csrftoken=")) {
                    return cookie.split("=")[1];
                }
            }
            return null;
        }
        
        function showPopup() {
            document.getElementById('popup').classList.remove('hidden');
        }
        
        function closePopup() {
            document.getElementById('popup').classList.add('hidden');
        }

        document.addEventListener("spaContentLoaded", async function () {
            const content1 = document.querySelector('.panel');
            const map = document.getElementById("map");
            const toggleButton = document.getElementById("toggleButton");
            const scrollToBottomBtn = document.getElementById("scrollToBottomBtn");
            const chatMessages = document.getElementById("chat-messages");
            let isLoading = false; // 로딩 상태를 관리하는 전역 변수
            let activeAbortController = null; // 현재 활성화된 AbortController
            let isChatHidden = false;
            let isScrollPaused = false; // 스크롤 이벤트 잠시 멈춤 플래그

            function scrollHandler() {
                if (isScrollPaused) return; // 스크롤 이벤트 멈춘 상태라면 실행하지 않음

                if (!isChatHidden) {
                    const isAtBottom = chatMessages.scrollTop + chatMessages.clientHeight >= chatMessages.scrollHeight - 10;
                    if (!isAtBottom) {
                        scrollToBottomBtn.classList.remove("hidden"); // ▼ 버튼 보이기
                    } else {
                        scrollToBottomBtn.classList.add("hidden"); // ▼ 버튼 숨김
                    }
                } else {
                    scrollToBottomBtn.classList.add("hidden"); // 채팅창이 숨겨진 경우 ▼ 버튼 숨김
                }
            }

            if (toggleButton) {
                toggleButton.addEventListener("click", function () {
                    if (isChatHidden) {
                        // 채팅 패널 다시 표시
                        isScrollPaused = true; // 스크롤 이벤트 잠시 멈춤
                        content1.style.width = "400px";
                        map.style.flexGrow = "1";
                        toggleButton.innerHTML = "&lt;&nbsp;";

                        setTimeout(() => {
                            isScrollPaused = false; // 일정 시간 후 스크롤 이벤트 재개
                            // chatMessages.dispatchEvent(new Event("scroll")); // 스크롤 강제 트리거
                        }, 100); // 100ms 대기 후 재개
                    } else {
                        // 채팅 패널 숨김
                        content1.style.width = "0";
                        map.style.flexGrow = "2";
                        toggleButton.innerHTML = "&gt;&nbsp;";
                        if (scrollToBottomBtn) {
                            scrollToBottomBtn.classList.add("hidden"); // ▼ 버튼 숨김
                        }
                    }
                    isChatHidden = !isChatHidden; // 상태 변경
                });
            }

            if (chatMessages && scrollToBottomBtn) {
                chatMessages.addEventListener("scroll", scrollHandler);
                scrollToBottomBtn.addEventListener("click", function () {
                    // ▼ 버튼 클릭 시 채팅창 맨 아래로 스크롤
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    scrollToBottomBtn.classList.add("hidden"); // 버튼 숨김
                });
            }
            
            // 1) Planner Panel
            const plannerPanel = document.getElementById("plannerPanel");
            if (plannerPanel) {
                console.log("[Planner] panel detected!");                
                const resetButton = document.getElementById("resetButton");
                const plannerTitle = document.getElementById("planner-title");
                const changeTitle = document.getElementById("change-title");
                const chatMessages = document.getElementById('chat-messages');
                const initialMessage = localStorage.getItem('chatMessage');
                const newMessage = document.createElement("div");
                const urlParams = new URLSearchParams(window.location.search);
                const chatId = urlParams.get("chat_id");

                if (isLoggedIn) { // 로그인된 경우
                    if (chatId) {
                        try {
                            // 서버에서 제목 가져오기
                            const response = await fetch(`/app/partials/planner/get_title/?chat_id=${encodeURIComponent(chatId)}`);
                            const result = await response.json();

                            if (result.success && result.title) {
                                plannerTitle.textContent = result.title; // 제목 업데이트
                            } else {
                                console.error("Failed to fetch title:", result.error || "Unknown error");
                                plannerTitle.textContent = "Default Title"; // 실패 시 기본값
                            }
                            // 채팅 내용 가져오기
                            fetch(`/app/partials/planner/get_chat_content/?chat_id=${encodeURIComponent(chatId)}`)
                                .then(response => {
                                    if (!response.ok) {
                                        throw new Error(`Failed to fetch chat content: ${response.status}`);
                                    }
                                    return response.json();
                                })
                                .then(data => {
                                    if (data.success && data.content) {
                                        parseAndDisplayChatContent(data.content); // 채팅 내용 파싱 및 UI 표시
                                    } else {
                                        console.log("No content for the provided chat_id.");
                                    }
                                })
                                .catch(error => {
                                    console.error("Error fetching chat content:", error);
                                });
                        } catch (error) {
                            console.error("Error fetching title or chat content:", error);
                            plannerTitle.textContent = "Default Title"; // 오류 시 기본값
                        }
                    } else {
                        // chat_id가 없는 경우, 새로운 제목 생성
                        try {
                            const response = await fetch("/app/partials/chatting/");
                            const html = await response.text();

                            const tempDiv = document.createElement("div");
                            tempDiv.innerHTML = html;

                            const chatItems = tempDiv.querySelectorAll(".chat-item");
                            const chatCount = chatItems.length;

                            const newTitle = `chat${chatCount + 1}`;
                            plannerTitle.textContent = newTitle;
                        } catch (error) {
                            console.error("Error calculating chat count:", error);
                            plannerTitle.textContent = "chat1"; // 기본값 설정
                        }
                    }
                } 
                else {
                    try {
                        const response = await fetch("/app/partials/chatting/");
                        const html = await response.text();

                        const tempDiv = document.createElement("div");
                        tempDiv.innerHTML = html;

                        const chatItems = tempDiv.querySelectorAll(".chat-item");
                        const chatCount = chatItems.length;

                        plannerTitle.textContent = `chat1`;
                    } catch (error) {
                        console.error("Error calculating chat count:", error);
                    }
                }

                if (initialMessage) {
                    saveChatToDB(`<나>${initialMessage}`);
                    newMessage.className = "bubble right-bubble";
                    newMessage.innerHTML = initialMessage.replace(/\n/g, "<br>");
                    chatMessages.appendChild(newMessage);
                    
                    const loadingBubble = document.createElement("div");
                    loadingBubble.classList.add("bubble", "left-bubble", "loading-bubble");
                    loadingBubble.innerHTML = `
                        <div class="loader">
                            <span></span>
                            <span></span>
                            <span></span>
                        </div>
                    `;
                    chatMessages.appendChild(loadingBubble);
                            
                    try {
                        const gptResponse = await fetchGPTResponse(initialMessage);

                        if (gptResponse) {
                            console.log("봇1:", gptResponse);
                            saveChatToDB(`<봇>${gptResponse}`);
                            // GPT 응답 표시
                            const botBubble = document.createElement("div");
                            botBubble.classList.add("bubble", "left-bubble");
                            botBubble.addEventListener("mouseenter", function (event) {
                                const currentBackgroundColor = window.getComputedStyle(this).backgroundColor;
                                if (botBubble.className.includes("left-bubble")) {
                                    this.style.backgroundColor = "#589258"; // 기본 하이라이트 색상
                                }
                            });

                            botBubble.addEventListener("mouseleave", function (event) {
                                const target = event.target;
                                const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                                if (botBubble.className.includes("left-bubble")) {
                                    this.style.backgroundColor = ""; // 원래 배경색 복구
                                }
                            });

                            botBubble.addEventListener("click", function (event) {
                                const target = event.target;
                                const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                                const messageContent = this.innerHTML.trim(); // 메시지 내용 가져오기
                                
                                if (botBubble.className.includes("left-bubble")) {
                                    // 서식을 유지한 상태로 출력
                                    const panelTitle = document.getElementById("panel-title");
                                    panelTitle.textContent = "";
                                    const formattedMessage = messageContent
                                        .replace(/<br\s*\/?>/gi, "\n") // <br> 태그를 줄바꿈으로 변환
                                        .replace(/&nbsp;/g, " ");     // &nbsp;를 공백으로 변환

                                    const jsonData = parseItineraryToJson(formattedMessage);
                                    if (jsonData.length > 0) {
                                        generateDayButtons(jsonData);
                                        generateDynamicPlanContent(jsonData);

                                        const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                        getBookmarkListBtn.setAttribute("json_data", JSON.stringify(jsonData));
                                    }
                                }
                            });
                            chatMessages.appendChild(botBubble); // DOM에 추가
                            chatMessages.scrollTop = chatMessages.scrollHeight;
                            typeText(botBubble, gptResponse, loadingBubble);
                        } else {
                            console.error("GPT 응답이 없습니다.");
                        }
                    } catch (error) {
                        console.error("Error fetching GPT response:", error);
                        chatMessages.removeChild(loadingBubble); // 오류 시 로딩 애니메이션 삭제
                    }                    
                }             

                if (plannerTitle) {
                    plannerTitle.addEventListener("dblclick", function () {
                        changeTitle.value = plannerTitle.textContent;
                        changeTitle.style.display = "block"; // 입력창 표시
                        plannerTitle.style.display = "none"; // 기존 텍스트 숨김
                        changeTitle.focus();
                    });

                    // 2) Enter: 제목 저장, ESC: 취소
                    changeTitle.addEventListener("keydown", async function (e) {
                        if (event.key === "Enter") {
                            const newTitle = changeTitle.value.trim();
                            const titleText = document.getElementById("planner-title"); 
                            
                            if (!newTitle) {
                                alert("제목을 입력해주세요.");
                                return;
                            }

                            plannerTitle.style.display = "block"; // 기존 텍스트 표시
                            changeTitle.style.display = "none"; // 입력창 숨김

                            try {
                                // 중복 확인 API 호출
                                const response = await fetch("/app/partials/planner/check_duplicate_title/", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCSRFToken(),
                                    },
                                    body: JSON.stringify({ title: newTitle }),
                                });

                                const result = await response.json();

                                if (result.is_duplicate) {
                                    alert("중복된 제목입니다. 다른 제목을 입력해주세요.");
                                    return;
                                }

                                // 제목 업데이트 API 호출
                                const updateResponse = await fetch("/app/partials/planner/update_title/", {
                                    method: "POST",
                                    headers: {
                                        "Content-Type": "application/json",
                                        "X-CSRFToken": getCSRFToken(),
                                    },
                                    body: JSON.stringify({ chat_id: chatId, title: newTitle }),
                                });

                                const updateResult = await updateResponse.json();
                                if (updateResult.success) {
                                    plannerTitle.textContent = newTitle;
                                    plannerTitle.style.display = "block";
                                    changeTitle.style.display = "none";
                                } else {
                                    console.error("Failed to update title:", updateResult.error || "Unknown error");
                                }
                            } catch (error) {
                                console.error("Error checking/updating title:", error);
                            }
                        } else if (event.key === "Escape") {
                            plannerTitle.style.display = "block"; // 기존 텍스트 표시
                            changeTitle.style.display = "none";  // 입력창 숨김
                        }                    
                    });
                }                

                resetButton.addEventListener("click", function () {
                    // URL에서 chat_id 추출
                    const urlParams = new URLSearchParams(window.location.search);
                    const chatId = urlParams.get("chat_id");
                    console.log("ChatID:", chatId);

                    if (!chatId) {
                        // alert("삭제할 chat_id를 찾을 수 없습니다.");
                        return;
                    }

                    // 사용자 확인
                    const confirmReset = confirm("정말 이 채팅 내용을 초기화하시겠습니까?");
                    if (!confirmReset) return;

                    // 서버로 삭제 요청
                    fetch("/app/partials/planner/init_chat/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                        body: JSON.stringify({ chat_id: chatId }),
                    })
                        .then(response => {
                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }
                            return response.json();
                        })
                        .then(data => {
                            if (data.success) {
                                alert("채팅 내용이 초기화되었습니다.");
                                // UI에서 내용을 비웁니다.
                                const chatMessages = document.getElementById("chat-messages");
                                if (chatMessages) chatMessages.innerHTML = "";
                            } else {
                                alert("초기화 실패: " + (data.error || "알 수 없는 오류"));
                            }
                        })
                        .catch(error => {
                            console.error("Error resetting chat content:", error);
                            alert("서버 오류가 발생했습니다. 다시 시도해주세요.");
                        });
                });
            }
            
            // 2) Chatting Panel
            const chattingPanel = document.getElementById("chattingPanel");
            if (chattingPanel) {
                console.log("[Chatting] panel detected!");

                const chatList = document.querySelector(".chat-list");

                function updateChatListScroll() {
                    if (chatList.children.length > 10) {
                        chatList.classList.remove("fewer-than-ten");
                    } else {
                        chatList.classList.add("fewer-than-ten");
                    }
                }

                // 페이지 로드 시 실행
                updateChatListScroll();

                // 채팅 아이템이 추가되거나 제거될 때 실행 (예시 이벤트 리스너)
                document.addEventListener("chatListUpdated", updateChatListScroll);

                // 채팅 삭제 버튼 눌렀을 때 채팅을 삭제함
                const deleteIcons = document.querySelectorAll(".delete-icon");
                deleteIcons.forEach((icon) => {
                    icon.addEventListener("click", async function (e) {
                        e.stopPropagation();

                        const chatId = this.dataset.id;
                        if (!chatId) return;

                        const confirmed = confirm("Are you sure you want to delete this chat?");
                        if (!confirmed) return;

                        try {
                            const response = await fetch("/app/partials/chatting/delete/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken(),
                                },
                                body: JSON.stringify({ chatting_id: chatId }),
                            });

                            const result = await response.json();
                            if (result.success) {
                                alert("Chat deleted successfully!");
                                this.closest(".chat-item").remove(); // UI에서 삭제
                            } else {
                                alert(`Error: ${result.error || "Failed to delete chat."}`);
                            }
                        } catch (error) {
                            console.error("Error deleting chat:", error);
                            alert("An error occurred. Please try again.");
                        }
                    });
                });

                // chat-item 클릭 -> /app/planner/?chat_id=xxx 형태 (250118:뭐하는 코드지?)
                document.querySelectorAll(".chat-item").forEach(item => {
                    item.addEventListener("click", function() {
                        const chatId = this.getAttribute("data-chat-id");
                        const targetUrl = `/app/planner/?chat_id=${encodeURIComponent(chatId)}`;
                        history.pushState(null, '', targetUrl);
                        loadContent(targetUrl);
                    });
                });
            }
            
            // 3) Favorites Panel
            const favoritesPanel = document.getElementById("favoritesPanel");
            if (favoritesPanel) {
                console.log("[Favorites] favoritesPanel detected!");
                // --------------------------------
                // (A) 탭 전환 로직
                // --------------------------------
                const backBtn = document.getElementById('backBtn');
                const bookmarkTitle = document.getElementById('bookmark_title');
                const placeBtn = document.getElementById('placeBtn');
                const scheduleBtn = document.getElementById('scheduleBtn');
                const topmenu = document.querySelector('.top-menu');
                const placesSection = document.getElementById('placesSection');
                const scheduleSection = document.getElementById('scheduleSection');
                const bodyElement = document.body; // 테마를 확인하기 위한 body 요소

                //즐겨찾기 페이지에서 뒤로 가기 버튼 눌렀을 때 기능
                backBtn.addEventListener('click', () => {
                    backBtn.style.display = "none";
                    bookmarkTitle.style.display = "none";
                    placeBtn.style.display = "block";
                    scheduleBtn.style.display = "block";
                    topmenu.style.justifyContent = "space-evenly";
                    document.querySelector('.folder-list').style.display = "block";
                    document.querySelector('.bookmark-place-item').style.display = "none";
                    document.querySelector('.bookmark-schedule-item').style.display = "none";

                    const AllFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                    const bookmarkPlaceItemDiv = document.querySelector(".bookmark-place-item");
                    const bookmarkScheduleItemDiv = document.querySelector(".bookmark-schedule-item");
                    
                    if (AllFolderLists) {
                        AllFolderLists.forEach(folderList => {
                            folderList.style.display = "block";
                        });
                    }
                });

                //즐겨찾기 페이지에서 장소 / 일정 버튼 눌렀을 때 기능
                if (placeBtn && scheduleBtn && placesSection && scheduleSection) {
                    placeBtn.addEventListener('click', function() {
                        placesSection.style.display = 'block';
                        scheduleSection.style.display = 'none';

                        placeBtn.style.backgroundColor = '#999';
                        scheduleBtn.style.backgroundColor = '';

                        topmenu.style.justifyContent = "space-evenly";
                        backBtn.style.display = "none";
                        bookmarkTitle.style.display = "none";
                        placeBtn.style.display = "block";
                        scheduleBtn.style.display = "block";
                    });

                    scheduleBtn.addEventListener('click', function() {
                        scheduleSection.style.display = 'block';
                        placesSection.style.display = 'none';

                        scheduleBtn.style.backgroundColor = '#999';
                        placeBtn.style.backgroundColor = '';

                        topmenu.style.justifyContent = "space-evenly";
                        backBtn.style.display = "none";
                        bookmarkTitle.style.display = "none";
                        placeBtn.style.display = "block";
                        scheduleBtn.style.display = "block";
                    });

                    placeBtn.click();
                }
                
                // --------------------------------
                // (C) 장소 폴더 만들기 로직
                // --------------------------------
                
                const plusPlace = document.getElementById("plus-place");
                addFolderEventHandler(
                    "plus-place",
                    "#placesSection",
                    "새 폴더 이름 입력 (Enter)",
                    true,
                    { light: "/static/images/folder_light.png", dark: "/static/images/folder_dark.png" }
                );
                
                // --------------------------------
                // (D) 일정 만들기 로직
                // --------------------------------
                
                const plusSchedule = document.getElementById("plus-schedule");
                addFolderEventHandler(
                    "plus-schedule",
                    "#scheduleSection",
                    "새 일정 이름 입력 (Enter)",
                    false,
                    { light: "/static/images/schedule_light.png", dark: "/static/images/schedule_dark.png" }
                );
                // --------------------------------------------------------
                // (E) 페이지 로드 시, 기존 아이템들에도 삭제 이벤트 연결
                // --------------------------------------------------------
                // 만약 "기존 아이템"에도 삭제 아이콘이 있다면 적용
                const allFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                allFolderLists.forEach(listEl => {
                    // 해당 섹션이 "장소" 섹션이면 plusPlace를, 
                    // "일정" 섹션이면 plusSchedule을 연결해야 함
                    let plusBtn = null;
                    if (listEl.closest('#placesSection')) {
                        plusBtn = plusPlace;
                    } else if (listEl.closest('#scheduleSection')) {
                        plusBtn = plusSchedule;
                    }
                    // 아이템 스캔
                    const items = listEl.querySelectorAll('.folder-item');
                    items.forEach(item => attachDeleteEvent(item, listEl, plusBtn));

                    // 초기 스크롤/버튼상태 갱신
                    updateFolderListUI(listEl, plusBtn);
                });

                const folderItems = document.querySelectorAll(".folder-item");
                // 각 folder-item에 클릭 이벤트 추가
                folderItems.forEach(item => {
                    item.addEventListener("click", async function () {
                        if (event.target.classList.contains("delete-icon")) {
                            return; // 삭제 버튼 클릭 시 folder-item의 이벤트 실행 차단
                        }
                        
                        // 새 폴더 버튼은 해당 안하니까 패스
                        if (item.id !== "plus-place" && item.id !== "plus-schedule") {
                            const backBtn = document.getElementById('backBtn');
                            const backbookmarkTitleBtn = document.getElementById('bookmark_title');
                            const placeBtn = document.getElementById('placeBtn');
                            const scheduleBtn = document.getElementById('scheduleBtn');
                            const topmenu = document.querySelector('.top-menu');
                            const AllFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                            const bookmarkPlaceItemDiv = document.querySelector(".bookmark-place-item");
                            const bookmarkScheduleItemDiv = document.querySelector(".bookmark-schedule-item");
                            
                            if (AllFolderLists) {
                                AllFolderLists.forEach(folderList => {
                                    folderList.style.display = "none";
                                });
                            }
                            
                            topmenu.style.justifyContent = "start";
                            backBtn.style.display = "block";
                            backbookmarkTitleBtn.style.display = "block";
                            backbookmarkTitleBtn.textContent = item.textContent.trim().replace(/\s{2,}/g, '').replace(/\u00a0+/g, '');
                            placeBtn.style.display = "none";
                            scheduleBtn.style.display = "none";

                            // bookmark-place-item과 bookmark-schedule-item 초기화
                            if (bookmarkPlaceItemDiv) {                            
                                bookmarkPlaceItemDiv.style.display = "none";
                                bookmarkPlaceItemDiv.innerHTML = ""; // 기존 자식 요소 제거
                            }
                            if (bookmarkScheduleItemDiv) {
                                bookmarkScheduleItemDiv.style.display = "none";
                                bookmarkScheduleItemDiv.innerHTML = ""; // 기존 자식 요소 제거
                            }
                            
                            const bookmarkId = this.id; // 클릭된 div의 ID 가져오기
                            if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                return; // "새 폴더" 버튼 클릭 시 무시
                            }

                            try {
                                // 서버에 bookmark_id로 데이터 요청
                                const response = await fetch(`/app/partials/favorites/get_bookmark_items/${bookmarkId}/`, {
                                    method: "GET",
                                    headers: {
                                        "Content-Type": "application/json",
                                    },
                                });

                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }

                                const data = await response.json();
                                if (data.type === "place") {
                                    // 장소 즐겨찾기
                                    if (bookmarkPlaceItemDiv) {
                                        bookmarkPlaceItemDiv.style.display = "block";

                                        data.rows.forEach(row => {
                                            const itemDiv = document.createElement("div");
                                            itemDiv.className = "place-item";
                                            itemDiv.id = row.id;
                                            itemDiv.innerHTML = `
                                                <p style="display: flex; align-items: center;"><strong>이름:</strong> ${row.name}</p>
                                            `;
                                            itemDiv.addEventListener("click", async () => {
                                                //DB에서 해당 데이터 불러오기
                                                document.querySelectorAll(".place-item").forEach(folder => {                                                
                                                    folder.style.backgroundColor = ""; // 원래 색으로 복원 (CSS 초기값)
                                                });
                                                document.getElementById("getBookmarkListBtn").textContent = "★";
                                                itemDiv.style.backgroundColor = "#999";

                                                const bookmarkId = this.id; // folder-item의 ID 값
                                                if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                                    return; // "새 폴더" 버튼은 클릭 이벤트 무시
                                                }

                                                try {
                                                    // 서버에 bookmark_id로 데이터 요청
                                                    const response = await fetch(`/app/partials/favorites/bookmark-place-detail/${row.id}/`, {
                                                        method: "GET",
                                                        headers: {
                                                            "Content-Type": "application/json",
                                                        },
                                                    });

                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }
                                                    
                                                    // UI 업데이트: map-panel-content 또는 다른 요소에 데이터 표시
                                                    const data = await response.json(); // JSON 응답 파싱
                                                    const mapPanelContent = document.querySelector(".map-panel-content");
                                                    if (!mapPanelContent) {
                                                        console.error("map-panel-content element not found");
                                                        return;
                                                    }

                                                    // 기존 내용 제거
                                                    mapPanelContent.innerHTML = "";

                                                    // 장소 정보 표시
                                                    if (data) {
                                                        const panelTitle = document.getElementById("panel-title");                                                        
                                                        panelTitle.innerHTML = `${row.name}`;
                                                        const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                                        getBookmarkListBtn.classList.remove("schedule");
                                                        getBookmarkListBtn.classList.add("place");
                                                        getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                                        getBookmarkListBtn.setAttribute("bookmarkplace_id", row.id);
                                                        getBookmarkListBtn.setAttribute("json_data", null);
                                                        const placeSection = document.createElement("div");
                                                        placeSection.className = "place-section";
                                                        placeSection.innerHTML = `
                                                            <h3>장소 정보</h3>
                                                            <p><strong>이름:</strong> ${data.name}</p>
                                                            <p><strong>주소:</strong> ${data.address}</p>
                                                            <p><strong>설명:</strong> ${data.description || "설명이 없습니다."}</p>
                                                        `;
                                                        mapPanelContent.appendChild(placeSection);
                                                        if (data.longitude && data.latitude && data.name) {
                                                            const markerData = [];
                                                            markerData.push({
                                                                position: new naver.maps.LatLng(data.latitude, data.longitude),
                                                                title: data.name,
                                                                icon: `https://chart.googleapis.com/chart?chst=d_map_pin_number&chld=${markerData.length + 1}|FF0000|000000`,
                                                            });
                                                            addMarkersToMap(markerData);
                                                        }
                                                        else if (data.address && data.name) {
                                                            const addresses = [];
                                                            addresses.push({
                                                                address: data.address,
                                                                title: data.name,
                                                            })
                                                            globalMarkerData = await getCoordinates(addresses);
                                                            addMarkersToMap(globalMarkerData);
                                                        }
                                                        else {
                                                            console.log("data에 든 게 하나도 없으니 마커를 띄우길 포기");
                                                        }
                                                    } else {
                                                        const noDataMessage = document.createElement("p");
                                                        noDataMessage.textContent = "해당 데이터가 없습니다.";
                                                        mapPanelContent.appendChild(noDataMessage);
                                                    }
                                                } catch (error) {
                                                    console.error("Error fetching bookmark place data:", error);
                                                }
                                            });

                                            // 삭제 버튼 추가
                                            const deleteButton = document.createElement('img');
                                            deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                                ? '/static/images/delete_light.png' 
                                                : '/static/images/delete_dark.png';
                                            deleteButton.style.cursor = 'pointer';
                                            deleteButton.style.marginLeft = 'auto';
                                            deleteButton.style.marginRight = '10px';
                                            deleteButton.style.opacity = '0.7';
                                            deleteButton.width = 25;
                                            deleteButton.height = 25;

                                            // 삭제 버튼 이벤트 추가
                                            deleteButton.addEventListener('click', (event) => {
                                                event.stopPropagation();
                                                // UI에서 제거
                                                bookmarkPlaceItemDiv.removeChild(itemDiv);

                                                //DB에서도 해당 데이터 제거
                                                console.log("bookmarkplace_id:", row.bookmark); //bm_00001
                                                console.log("data:", row.id); 
                                                deleteBookmarklist(row);
                                            });

                                            deleteButton.addEventListener('mouseover', () => {
                                                deleteButton.style.opacity = '1.0';
                                            });

                                            deleteButton.addEventListener('mouseleave', () => {
                                                deleteButton.style.opacity = '0.7';
                                            });

                                            itemDiv.appendChild(deleteButton);
                                            bookmarkPlaceItemDiv.appendChild(itemDiv);
                                        });
                                    }
                                } 
                                else if (data.type === "schedule") {
                                    // 일정 즐겨찾기
                                    if (bookmarkScheduleItemDiv) {
                                        bookmarkScheduleItemDiv.style.display = "block";

                                        data.rows.forEach(row => {
                                            const itemDiv = document.createElement("div");
                                            itemDiv.className = "schedule-item";
                                            itemDiv.id = row.id;
                                            itemDiv.innerHTML = `
                                                <p style="display: flex; align-items: center;"><strong>이름:</strong> ${row.name}</p>
                                            `;
                                            itemDiv.addEventListener("click", async () => {
                                                document.querySelectorAll(".schedule-item").forEach(folder => {                                                
                                                    folder.style.backgroundColor = ""; // 원래 색으로 복원 (CSS 초기값)
                                                });

                                                document.getElementById("getBookmarkListBtn").textContent = "★";
                                                itemDiv.style.backgroundColor = "#999";

                                                const bookmarkId = this.id; // folder-item의 ID 값
                                                if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                                    return; // "새 폴더" 버튼은 클릭 이벤트 무시
                                                }

                                                try {
                                                    // 서버에 bookmark_id로 데이터 요청
                                                    const response = await fetch(`/app/partials/favorites/bookmark-schedule-detail/${row.id}/`, {
                                                        method: "GET",
                                                        headers: {
                                                            "Content-Type": "application/json",
                                                        },
                                                    });

                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }

                                                    // UI 업데이트: map-panel-content 또는 다른 요소에 데이터 표시
                                                    const data = await response.json(); // JSON 응답 파싱
                                                    const mapPanelContent = document.querySelector(".map-panel-content");
                                                    if (!mapPanelContent) {
                                                        console.error("map-panel-content element not found");
                                                        return;
                                                    }

                                                    // 기존 내용 제거
                                                    mapPanelContent.innerHTML = "";

                                                    // 일정 정보 표시
                                                    if (data) {;
                                                        const panelTitle = document.getElementById("panel-title");
                                                        panelTitle.innerHTML = `${row.name}`;
                                                        const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                                        getBookmarkListBtn.classList.remove("place");
                                                        getBookmarkListBtn.classList.add("schedule");
                                                        getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                                        getBookmarkListBtn.setAttribute("bookmarkschedule_id", row.id);
                                                        const jsonData = data.json_data;
                                                        console.log("werewr:", jsonData);
                                                        if (typeof json_data === "string") {
                                                            jsonData = JSON.parse(data.json_data);
                                                        }    
                                                        getBookmarkListBtn.setAttribute("json_data", jsonData);
                                                        generateDayButtons(jsonData);
                                                        generateDynamicPlanContent(jsonData);
                                                    } else {
                                                        const noDataMessage = document.createElement("p");
                                                        noDataMessage.textContent = "해당 데이터가 없습니다.";
                                                        mapPanelContent.appendChild(noDataMessage);
                                                    }
                                                } catch (error) {
                                                    console.error("Error fetching bookmark place data:", error);
                                                }
                                            });

                                            // 삭제 버튼 추가
                                            const deleteButton = document.createElement('img');
                                            deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                                ? '/static/images/delete_light.png' 
                                                : '/static/images/delete_dark.png';
                                            deleteButton.style.cursor = 'pointer';
                                            deleteButton.style.marginLeft = 'auto';
                                            deleteButton.style.marginRight = '10px';
                                            deleteButton.style.opacity = '0.7';
                                            deleteButton.width = 25;
                                            deleteButton.height = 25;

                                            // 삭제 버튼 이벤트 추가
                                            deleteButton.addEventListener('click', (event) => {
                                                event.stopPropagation();
                                                // UI에서 제거  
                                                itemDiv.remove();

                                                //DB에서도 해당 데이터 제거
                                                console.log("bookmarkplace_id:", row.bookmark); //bm_00001
                                                console.log("data:", row.id); 
                                                deleteBookmarklist(row);
                                            });

                                            deleteButton.addEventListener('mouseover', () => {
                                                deleteButton.style.opacity = '1.0';
                                            });

                                            deleteButton.addEventListener('mouseleave', () => {
                                                deleteButton.style.opacity = '0.7';
                                            });

                                            itemDiv.appendChild(deleteButton);
                                            bookmarkScheduleItemDiv.appendChild(itemDiv);
                                        });
                                    }
                                }
                                else {
                                    console.log("No data found");
                                }
                            } catch (error) {
                                console.error("Error fetching bookmark data:", error);
                            }
                        }
                    });
                });
            
            } // if (favoritesPanel)
            
            // 4) Settings Panel
            const settingsPanel= document.getElementById("settingsPanel");
            if (settingsPanel) {
                console.log("[settings] panel detected!");
                const lightBox = document.getElementById('light');
                const darkBox = document.getElementById('dark');
                const lightRadio = document.querySelector("input[name='theme'][value='light']");
                const darkRadio = document.querySelector("input[name='theme'][value='dark']");
                const themeRadios = document.querySelectorAll('input[name="theme"]');

                function selectTheme(theme) {
                    lightBox.classList.remove('selected');
                    darkBox.classList.remove('selected');

                    if (theme === 'light') {
                        lightBox.classList.add('selected');
                        lightRadio.checked = true;
                    } else if (theme === 'dark') {
                        darkBox.classList.add('selected');
                        darkRadio.checked = true;
                    }
                }

                lightBox.addEventListener('click', () => selectTheme('light'));
                darkBox.addEventListener('click', () => selectTheme('dark'));

                // 테마 선택 변경 시 서버에 업데이트
                themeRadios.forEach(radio => {
                    radio.addEventListener("change", () => {
                        const isLightTheme = radio.value === "light";
                        document.body.setAttribute("data-theme", isLightTheme ? "light" : "dark");
                        updateIconsBasedOnTheme();
                        
                        fetch("/app/partials/settings/update_theme/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCSRFToken(),
                            },
                            body: JSON.stringify({ is_white_theme: isLightTheme }),
                        })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error("Theme update failed.");
                                }
                                console.log("Theme updated successfully.");
                            })
                            .catch((err) => console.error("Error updating theme:", err));
                    });
                });

                const initialTheme = document.body.getAttribute("data-theme") === "light";
                updateIconsBasedOnTheme(initialTheme);

                const languageSelect = document.getElementById('language');
                if (languageSelect) {
                    languageSelect.addEventListener('change', async () => {
                        const selectedLanguage = languageSelect.value;

                        try {
                            const response = await fetch('/app/partials/settings/update_language/', {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json',
                                    'X-CSRFToken': getCSRFToken(), // CSRF 토큰 추가
                                },
                                body: JSON.stringify({ language: selectedLanguage }),
                            });

                            if (!response.ok) {
                                throw new Error(`HTTP error! status: ${response.status}`);
                            }

                            const result = await response.json();
                            if (result.success) {
                                // alert("Language updated successfully.");
                            } else {
                                alert(`Error: ${result.message}`);
                            }
                        } catch (error) {
                            console.error("Error updating language:", error);
                            alert("Failed to update language. Please try again.");
                        }
                    });
                }
            }

            // 5) Profile Panel
            const profilePanel = document.getElementById("profilePanel");
            if (profilePanel) {
                console.log("[profile] panel detected!");

                const profileImage = document.getElementById("profile-image");
                const popup = document.getElementById("image-popup");
                const popupImages = document.querySelectorAll(".popup-image");
                
                // 프로필 이미지를 클릭하면 팝업 표시
                profileImage.addEventListener("click", function () {
                    popup.classList.remove("hidden");
                    toggleButton.classList.add("hidden");
                });

                // 팝업 이미지 클릭 시 서버로 thumbnail_id 업데이트
                popupImages.forEach(image => {
                    image.addEventListener("click", function () {
                        const selectedId = this.dataset.id;

                        // 서버로 AJAX 요청
                        fetch("/app/partials/profile/update_thumbnail/", {
                            method: "POST",
                            headers: {
                                "Content-Type": "application/json",
                                "X-CSRFToken": getCSRFToken()
                            },
                            body: JSON.stringify({ thumbnail_id: selectedId })
                        })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then(data => {
                                if (data.success) {
                                    // 성공 시 프로필 이미지 업데이트
                                    profileImage.src = `/static/images/profiles/profile_${selectedId}.jpg`;                                    
                                } else {
                                    alert("Failed to update profile image: " + data.error);
                                }
                                popup.classList.add("hidden");
                                toggleButton.classList.remove("hidden");
                            })
                            .catch(err => {
                                console.error("Error updating profile image:", err);
                            });
                    });
                });

                // 팝업 외부 클릭 시 닫기
                if (popup) {
                    popup.addEventListener("click", function (e) {
                        if (e.target === popup) {
                            popup.classList.add("hidden");
                            toggleButton.classList.remove("hidden");
                        }
                    });
                }

                // 1) 닉네임 수정
                const nicknameText  = document.getElementById('nickname-text');
                const nicknameInput = document.getElementById('nickname-input');
                const editButton    = document.getElementById('edit-btn');
                const logoutBtn     = document.getElementById("logout-btn");

                let oldNickname = nicknameText ? nicknameText.textContent : "";

                let escNote = document.createElement("div");
                escNote.style.color = "#999";      // 예시 스타일
                escNote.style.fontSize = "0.9rem"; // 예시
                escNote.textContent = "(ENTER: edit / ESC: cancel)";

                if (editButton && nicknameText && nicknameInput) {
                    editButton.addEventListener("click", function() {
                        // 연필 버튼 클릭 시
                        oldNickname = nicknameText.textContent; // 현재 닉네임 저장
                        nicknameText.classList.add("hidden");   // 숨김
                        nicknameInput.classList.remove("hidden");
                        nicknameInput.value = oldNickname;      // 입력창 초기값
                        nicknameInput.focus();

                        const wrapper = document.querySelector(".nickname-wrapper");
                        if (wrapper) {
                            wrapper.appendChild(escNote);
                        }
                    });

                    // (1) Enter -> 저장
                    nicknameInput.addEventListener("keydown", function(e) {
                        if (e.key === "Enter") {
                            const newNickname = nicknameInput.value.trim();
                            if (newNickname) {
                                nicknameText.textContent = newNickname;
                            }
                            nicknameText.classList.remove("hidden");
                            nicknameInput.classList.add("hidden");

                            // 안내 문구 제거
                            removeEscNote();

                            // 서버로 AJAX 요청
                            fetch("/app/partials/profile/update_nickname/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken(),
                                },
                                body: JSON.stringify({ nickname: newNickname }),
                            })
                            .then((response) => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json(); // JSON 파싱
                            })
                            .then((data) => {
                                if (data.success) {
                                    // 성공 시 UI 업데이트
                                    nicknameText.textContent = newNickname;
                                } else {
                                    alert("닉네임 수정 실패: " + (data.error || "알 수 없는 오류"));
                                }
                            })
                            .catch((err) => {
                                console.error("서버 통신 오류:", err);
                                alert("서버 통신 오류: " + err.message);
                            })
                            .finally(() => {
                                // 입력창 숨기고 라벨 보이기
                                nicknameInput.classList.add("hidden");
                                nicknameText.classList.remove("hidden");
                            });
                        }
                        // (2) ESC -> 취소 (원래 닉네임 복원)
                        else if (e.key === "Escape") {
                            nicknameInput.value = oldNickname;
                            nicknameText.classList.remove("hidden");
                            nicknameInput.classList.add("hidden");

                            // 안내 문구 제거
                            removeEscNote();
                        }
                    });
                }

                // (4) 안내 문구 제거 함수
                function removeEscNote() {
                    if (escNote && escNote.parentNode) {
                        escNote.parentNode.removeChild(escNote);
                    }
                }

                // (5) 로그아웃 버튼
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", function() {
                        alert("로그아웃 처리 로직을 구현해주세요.");
                        window.location.href = "/";
                    });
                }

                // 로그아웃 버튼 예시
                if (logoutBtn) {
                    logoutBtn.addEventListener("click", function() {
                        alert("로그아웃 처리 로직을 구현해주세요.");
                        window.location.href = "/";
                    });
                }
            }
            
            // 6) 채팅 입력창 로직
            const inputBar = document.getElementById("input_bar");  
            const deleteBtn = document.querySelector('.delete-btn');
            const sendBtn = document.querySelector('.send-button');
            if (deleteBtn) {
                deleteBtn.addEventListener('click', showPopup);
            }

            if (inputBar) {
                inputBar.addEventListener("keydown", function (e) {
                    inputBarKeyDown(e, isLoading, inputBar);
                });
                inputBar.addEventListener("input", resizeInput);
                // resizeInput();
            }          
            
            if (sendBtn) {
                sendBtn.addEventListener("click", function (e) {
                    if (isLoading) {
                        e.preventDefault(); // 로딩 중일 때 입력 방지
                        alert("현재 봇 응답이 생성 중입니다. 잠시만 기다려주세요!");
                        return;
                    }

                    e.preventDefault();    
                    const chatMessages = document.getElementById("chat-messages");
                    chatMessages.scrollTop = chatMessages.scrollHeight;           
                    sendMessage();
                });
            }
            
            function inputBarKeyDown(e, isLoading, inputBar) {
                if (e.key === "Enter" && !e.shiftKey) {
                    if (isLoading) {
                        e.preventDefault(); // 로딩 중일 때 입력 방지
                        alert("현재 봇 응답이 생성 중입니다. 잠시만 기다려주세요!");
                        return;
                    }

                    e.preventDefault();    
                    const chatMessages = document.getElementById("chat-messages");
                    chatMessages.scrollTop = chatMessages.scrollHeight;           
                    sendMessage();
                    return false;
                } 
                else if (e.key === "Enter" && e.shiftKey) {
                    e.preventDefault();
                    const cursorPosition = inputBar.selectionStart;
                    inputBar.value =
                        inputBar.value.slice(0, cursorPosition) + "\n"
                        + inputBar.value.slice(cursorPosition);
                    // resizeInput();
                    return false;
                }
            }

            async function sendMessage() {
                if (isLoading) return; // 로딩 중일 때 메시지 전송 방지

                const message = inputBar.value.trim(); // 사용자가 입력한 메시지
                if (message === "") return;

                saveChatToDB(`<나>${message}`);

                // 1. 로딩 상태로 설정
                isLoading = true;
                inputBar.disabled = true; // 입력창 비활성화

                // 사용자의 메시지를 채팅창에 추가
                const userMessage = document.createElement("div");
                userMessage.className = "bubble right-bubble";
                userMessage.innerHTML = message.replace(/\n/g, "<br>");
                chatMessages.appendChild(userMessage);                

                inputBar.value = ""; // 입력창 초기화

                const loadingBubble = document.createElement("div");
                loadingBubble.classList.add("bubble", "left-bubble", "loading-bubble");
                loadingBubble.innerHTML = `
                    <div class="loader">
                        <span></span>
                        <span></span>
                        <span></span>
                    </div>
                `;
                chatMessages.appendChild(loadingBubble);

                try {
                    // 이전 AbortController가 있다면 중단
                    if (activeAbortController) {
                        activeAbortController.abort();
                    }

                    // 새로운 AbortController 생성
                    activeAbortController = new AbortController();
                    const { signal } = activeAbortController;

                    // 서버 요청 (AbortController로 취소 가능)
                    const response = await fetchGPTResponse(message, signal);

                    if (response) {
                        const botMessage = document.createElement("div");
                        botMessage.className = "bubble left-bubble";
                        chatMessages.appendChild(botMessage);
                        chatMessages.scrollTop = chatMessages.scrollHeight;
                        botMessage.addEventListener("mouseenter", function (event) {
                            const target = event.target;
                            const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                            if (botMessage.className.includes("left-bubble")) {
                                this.style.backgroundColor = "#589258"; // 기본 하이라이트 색상
                            }
                        });

                        // 마우스 아웃 이벤트
                        botMessage.addEventListener("mouseleave", function (event) {
                            const target = event.target;
                            const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                            if (botMessage.className.includes("left-bubble")) {
                                this.style.backgroundColor = ""; // 원래 배경색 복구
                            }
                        });

                        botMessage.addEventListener("click", function (event) {
                            const target = event.target;
                            const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                            const messageContent = this.innerHTML.trim(); // 메시지 내용 가져오기

                            if (botMessage.className.includes("left-bubble")) {
                                const panelTitle = document.getElementById("panel-title");
                                panelTitle.textContent = "";
                                // 서식을 유지한 상태로 출력
                                const formattedMessage = messageContent
                                    .replace(/<br\s*\/?>/gi, "\n") // <br> 태그를 줄바꿈으로 변환
                                    .replace(/&nbsp;/g, " ");     // &nbsp;를 공백으로 변환

                                const jsonData = parseItineraryToJson(formattedMessage);
                                if (jsonData.length > 0) {
                                    generateDayButtons(jsonData);
                                    generateDynamicPlanContent(jsonData);

                                    const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                    getBookmarkListBtn.setAttribute("json_data", JSON.stringify(jsonData));
                                }
                            }
                        });
                        console.log("봇2:", response); // botMessage의 HTML 내용을 출력
                        saveChatToDB(`<봇>${response}`); // HTML 내용을 문자열로 저장
                        typeText(botMessage, response, loadingBubble); // 타이핑 효과
                    }
                } catch (error) {
                    if (error.name === "AbortError") {
                        console.log("비동기 작업이 취소되었습니다.");
                    } else {
                        console.error("Error fetching GPT response:", error);
                        const errorMessage = document.createElement("div");
                        errorMessage.className = "bubble left-bubble error";
                        errorMessage.innerHTML = "오류가 발생했습니다. 다시 시도해주세요.";
                        chatMessages.appendChild(errorMessage);
                    }
                } finally {
                    isLoading = false;
                    inputBar.disabled = false; // 입력창 활성화
                    inputBar.focus();
                }
            }
            
            async function fetchGPTResponse(userInput, signal) {
                try {
                    const response = await fetch("/app/partials/planner/run-gpt/", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                            "X-CSRFToken": getCSRFToken(),
                        },
                        body: JSON.stringify({ question: userInput }),
                        signal, // AbortController에서 받은 signal 추가
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    return data.answer; // 서버로부터 받은 답변
                } catch (error) {
                    if (error.name === "AbortError") {
                        console.log("요청이 취소되었습니다.");
                    } else {
                        throw error;
                    }
                }
            }

            function resizeInput() {
                inputBar.style.height = "auto"; 
                const scrollHeight = inputBar.scrollHeight;
                const maxHeight = 120; 
                inputBar.style.height = `${Math.min(scrollHeight, maxHeight)}px`;

                if (scrollHeight >= maxHeight) {
                    inputBar.style.overflowY = "auto";
                } else {
                    inputBar.style.overflowY = "hidden";
                }
            }
        });

        function saveChatToDB(chatContent) {
            // 현재 URL에서 chat_id 추출
            localStorage.removeItem('chatMessage');
            const urlParams = new URLSearchParams(window.location.search);
            const chatId = urlParams.get("chat_id");
            console.log("saveChatToDB CHATID:", chatId);

            fetch("/app/partials/planner/save_chat/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(), // Django CSRF 토큰
                },
                body: JSON.stringify({
                    chat: chatContent,
                    chat_id: chatId, // URL에서 가져온 chat_id를 전송
                }),
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                if (!data.success) {
                    console.error("Failed to save chat to DB:", data.error);
                    if (data.error === "채팅 내역이 꽉 찼습니다!") {
                        // chat-container에 에러 메시지 말풍선 추가
                        const chatContainer = document.querySelector(".chat-container");
                        if (chatContainer) {
                            const errorBubble = document.createElement("div");
                            errorBubble.className = "error-bubble";
                            errorBubble.innerHTML = "채팅 내역이 꽉 찼습니다! 이 채팅은 저장되지 않습니다.<br>기존 채팅 내역을 사용해주세요.<br>현재 채팅에는 글 초기화 버튼이 작동하지 않습니다.";
                            errorBubble.style.position = "relative";
                            errorBubble.style.padding = "10px";
                            errorBubble.style.margin = "10px 0";
                            errorBubble.style.backgroundColor = "#ffcccc";
                            errorBubble.style.color = "#900";
                            errorBubble.style.border = "1px solid #f00";
                            errorBubble.style.borderRadius = "5px";
                            errorBubble.style.fontSize = "14px";

                            // 이미 말풍선이 존재하면 추가하지 않음
                            if (!chatContainer.querySelector(".error-bubble")) {
                                chatContainer.insertBefore(errorBubble, chatContainer.firstChild); // 맨 위에 추가
                            }
                        } else {
                            console.error("chat-container element not found.");
                        }
                    }
                } 
                else {
                    if (data.chatting_id) {
                        console.log("chat id:", data.chatting_id, "Chat saved successfully:", data.message || "Success", chatContent);
                        // 기존의 chat_id가 있었다면 URL을 업데이트
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set("chat_id", data.chatting_id); 
                        window.history.replaceState(null, "", newUrl.toString());
                        lastLoadedPath = newUrl.toString();
                    }
                    if (data.new_chat_id) {
                        console.log("chat id:", data.chatting_id, "New Chat ID:", data.message || "Success", chatContent);
                        // 새 chat_id가 생성되었다면 URL을 업데이트
                        const newChatId = data.new_chat_id;
                        const newUrl = new URL(window.location.href);
                        newUrl.searchParams.set("chat_id", newChatId);
                        window.history.replaceState(null, "", newUrl.toString());
                        lastLoadedPath = newUrl.toString();
                    }
                }
            })
            .catch(error => {
                console.error("Error saving chat to DB:", error);
            });
        }

        function typeText(element, text, loadingBubble, speed = 5) {
            let index = 0;

            // 로딩 버블 제거
            if (loadingBubble && loadingBubble.parentNode) {
                loadingBubble.parentNode.removeChild(loadingBubble);
            }

            // 타이핑 애니메이션 처리
            function typeNextChar() {
                if (index < text.length) {
                    const char = text[index] === "\n" ? document.createElement("br") : document.createTextNode(text[index]);
                    if (char instanceof Node) {
                        element.appendChild(char);
                    }
                    index++;

                    // 스크롤을 강제하지 않고도 실행
                    // element.scrollTop = element.scrollHeight;

                    setTimeout(typeNextChar, speed);
                } else {
                    // 애니메이션 종료 후 로딩 상태 해제
                    isLoading = false;
                }
            }
            typeNextChar();
        }

        function parseAndDisplayChatContent(chatContent) {
            if (!chatContent) {
                console.warn("chatContent가 비어있습니다.");
                return;
            }

            // HTML Escape 처리 제거
            chatContent = chatContent
                .replace(/&lt;/g, "<")
                .replace(/&gt;/g, ">")
                .replace(/&amp;/g, "&");

            // <나>, <봇> 기준으로 데이터 분리
            const tokens = chatContent.split(/(<나>|<봇>)/g).filter(token => token.trim() !== "");

            const chatMessages = document.getElementById("chat-messages");
            if (!chatMessages) {
                console.error("#chat-messages 요소를 찾을 수 없습니다.");
                return;
            }

            // 기존 DOM 초기화
            chatMessages.innerHTML = "";

            // 대화 내용 파싱 및 렌더링
            let currentSpeaker = null;
            tokens.forEach(token => {
                if (token === "<나>") {
                    currentSpeaker = "user";
                } else if (token === "<봇>") {
                    currentSpeaker = "bot";
                } else {
                    // 메시지 텍스트 처리
                    const bubble = document.createElement("div");
                    bubble.classList.add("bubble");
                    bubble.addEventListener("mouseenter", function (event) {
                        const target = event.target;
                        const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                        if (bubble.className.includes("left-bubble")) {
                            this.style.backgroundColor = "#589258"; // 기본 하이라이트 색상
                        }
                    });

                    // 마우스 아웃 이벤트
                    bubble.addEventListener("mouseleave", function (event) {
                        const target = event.target;
                        const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                        if (bubble.className.includes("left-bubble")) {
                            this.style.backgroundColor = ""; // 원래 배경색 복구
                        }
                    });

                    bubble.addEventListener("click", function (event) {
                        const target = event.target;
                        const currentBackgroundColor = window.getComputedStyle(target).backgroundColor;
                        const messageContent = this.innerHTML.trim(); // 메시지 내용 가져오기
                        if (bubble.className.includes("left-bubble")) {
                            const panelTitle = document.getElementById("panel-title");
                            panelTitle.textContent = "";

                            // 서식을 유지한 상태로 출력
                            const formattedMessage = messageContent
                                .replace(/<br\s*\/?>/gi, "\n") // <br> 태그를 줄바꿈으로 변환
                                .replace(/&nbsp;/g, " ");     // &nbsp;를 공백으로 변환

                            // Example Usage
                            const jsonData = parseItineraryToJson(formattedMessage);
                            if (jsonData.length > 0) {
                                generateDayButtons(jsonData);
                                generateDynamicPlanContent(jsonData);
    
                                const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                getBookmarkListBtn.setAttribute("json_data", JSON.stringify(jsonData));
                            }
                        }
                    });

                    // 서식 그대로 출력
                    const formattedText = token
                        .replace(/\\n/g, "<br>")   // 줄바꿈
                        .replace(/\\r/g, "")      // \r 제거
                        .replace(/ {2}/g, "&nbsp;&nbsp;"); // 연속된 띄어쓰기 처리

                    bubble.innerHTML = formattedText;

                    // 스피커에 따라 스타일 지정
                    if (currentSpeaker === "user") {
                        bubble.classList.add("right-bubble");
                    } else if (currentSpeaker === "bot") {
                        bubble.classList.add("left-bubble");
                    }

                    chatMessages.appendChild(bubble);
                }
            });
        }

        function parseItineraryToJson(text) {
            const lines = text.split("\n");
            const result = [];
            let currentDay = null;
            let currentMeal = null;
            let currentSection = null;

            lines.forEach(line => {
                const trimmedLine = line.trim();

                if (!trimmedLine) return; // 빈 줄 무시

                const isDayHeader = trimmedLine.startsWith("###");
                const isMealHeader = trimmedLine.match(/- \*\*(아침|점심|저녁)\*\*/);
                const isKeyValuePair = trimmedLine.startsWith("-");

                // Day header 처리
                if (isDayHeader) {
                    const dayMatch = trimmedLine.match(/^### (\d+)일차/);
                    if (dayMatch) {
                        currentDay = {
                            day: parseInt(dayMatch[1]),
                            meals: {}
                        };
                        result.push(currentDay);
                    }
                    return;
                }

                // Meal header 처리
                if (isMealHeader) {
                    const mealMatch = trimmedLine.match(/- \*\*(.*?)\*\*/);
                    if (mealMatch) {
                        currentMeal = mealMatch[1];
                        if (currentDay && !currentDay.meals[currentMeal]) {
                            currentDay.meals[currentMeal] = {
                                식사장소: {
                                    장소: null,
                                    주소: null,
                                    영업시간: null,
                                    음식점특징: null,
                                    기타정보: null
                                },
                                명소: {
                                    명소이름: null,
                                    영업시간: null,
                                    명소특징: null,
                                    명소위치: null,
                                    기타정보: null
                                }
                            };
                        }
                        currentSection = null;
                    }
                    return;
                }

                // Key-Value 처리
                if (isKeyValuePair) {
                    const keyValueMatch = trimmedLine.match(/- \*\*(.*?)\*\*: (.*)/);
                    if (keyValueMatch && currentDay && currentMeal) {
                        const [, key, value] = keyValueMatch;
                        const mealSection = currentDay.meals[currentMeal];

                        // 식사 장소와 명소 구분
                        if (key.includes("식사 장소")) {
                            mealSection.식사장소.장소 = value;
                            currentSection = "식사장소";
                        } else if (key === "명소") {
                            mealSection.명소.명소이름 = value;
                            currentSection = "명소";
                        } else if (currentSection) {
                            if (currentSection === "식사장소") {
                                if (key === "주소") mealSection.식사장소.주소 = value;
                                if (key === "영업 시간") mealSection.식사장소.영업시간 = value;
                                if (key === "음식점 특징") mealSection.식사장소.음식점특징 = value;
                                if (key === "기타 정보") mealSection.식사장소.기타정보 = value;
                            } else if (currentSection === "명소") {
                                if (key === "영업 시간") mealSection.명소.영업시간 = value;
                                if (key === "명소 특징") mealSection.명소.명소특징 = value;
                                if (key === "명소 위치") mealSection.명소.명소위치 = value;
                                if (key === "기타 정보") mealSection.명소.기타정보 = value;
                            }
                        }
                    }
                }
            });

            return result;
        }

        function attachDeleteEvent(folderItem, parentList, plusButton) {
            const deleteIcon = folderItem.querySelector('.delete-icon');
            if (!deleteIcon) return;

            deleteIcon.addEventListener('click', function() {
                // (A) bookmark_id 가져오기
                const bookmarkId = deleteIcon.getAttribute('data-id');
                if (!bookmarkId) {
                    console.warn("No data-id found for this item, cannot delete in DB.");
                    return;
                }

                // (B) 서버에 DELETE 요청(AJAX)
                fetch("/app/partials/favorites/delete/", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                        "X-CSRFToken": getCSRFToken()  // CSRF 토큰
                    },
                    body: JSON.stringify({
                        bookmark_id: bookmarkId
                    })
                })
                .then(response => {
                    if (!response.ok) {
                        // 예: 404, 500 등이면 throw
                        throw new Error(`HTTP error: ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.success) {
                        // (C) 성공하면 UI에서 제거
                        folderItem.remove();
                        // parentList.removeChild(folderItem);
                        updateFolderListUI(parentList, plusButton);
                        console.log("북마크 삭제 성공:", bookmarkId);
                    } else {
                        // (D) 실패 처리
                        alert("삭제 실패: " + (data.error || "unknown error"));
                    }
                })
                .catch(err => {
                    console.error("서버 통신 오류:", err);
                    alert("서버 오류가 발생했습니다.");
                });
            });
        }

        function updateFolderListUI(folderList, plusButton) {
            if (!folderList) return;

            const items = folderList.querySelectorAll('.folder-item');
            const count = items.length;

            // 버튼 비활성화: 10개 이상이면 disabled
            if (plusButton) {
                if (count >= 11) {
                    plusButton.style.pointerEvents = 'none';
                    plusButton.style.opacity = '0.4';
                    // 또는 plusButton.setAttribute('disabled', true);
                } else {
                    plusButton.style.pointerEvents = 'auto';
                    plusButton.style.opacity = '1';
                    // plusButton.removeAttribute('disabled');
                }
            }
        }

        function addFolderEventHandler(plusElementId, sectionSelector, placeholderText, isPlaceValue, imagePaths) {
            const plusElement = document.getElementById(plusElementId);
            if (plusElement) {
                plusElement.addEventListener('click', function () {
                    // 이미 입력창이 열려있으면 무시
                    if (isPlaceValue ? isPlaceInputOpen : isScheduleInputOpen) return;
                    if (isPlaceValue) isPlaceInputOpen = true;
                    else isScheduleInputOpen = true;

                    const folderList = document.querySelector(`${sectionSelector} .folder-list`);
                    if (!folderList) return;

                    // 새 입력창 아이템
                    const inputItem = document.createElement("div");
                    inputItem.className = "folder-item";

                    const inputElem = document.createElement("input");
                    inputElem.type = "text";
                    inputElem.placeholder = placeholderText;
                    inputElem.style.width = "200px";

                    inputItem.appendChild(inputElem);

                    folderList.insertBefore(inputItem, plusElement);

                    updateFolderListUI(folderList, plusElement);

                    inputElem.focus();

                    // Enter로 확정
                    inputElem.addEventListener("keydown", function (e) {
                        if (e.key === "Enter") {
                            e.preventDefault();
                            const textValue = inputElem.value.trim();
                            const isLightTheme = document.body.getAttribute("data-theme") === "light";

                            if (isPlaceValue) isPlaceInputOpen = false;
                            else isScheduleInputOpen = false;

                            // 입력이 없으면 취소
                            if (textValue === "") {
                                folderList.removeChild(inputItem);
                                updateFolderListUI(folderList, plusElement);
                                return;
                            }

                            // 서버로 AJAX 호출
                            fetch("/app/partials/favorites/add/", {
                                method: "POST",
                                headers: {
                                    "Content-Type": "application/json",
                                    "X-CSRFToken": getCSRFToken()
                                },
                                body: JSON.stringify({
                                    title: textValue,
                                    is_place: isPlaceValue,
                                })
                            })
                            .then(response => {
                                if (!response.ok) {
                                    throw new Error(`HTTP error! status: ${response.status}`);
                                }
                                return response.json();
                            })
                            .then((data) => {
                                if (data.success) {
                                    // 생성 성공 시, 새 아이템 생성
                                    const newItem = document.createElement("div");
                                    newItem.className = "folder-item";
                                    newItem.id = data.folderId; // 서버에서 반환된 folderId를 id로 설정
                                    newItem.innerHTML = `
                                        <img src="${isLightTheme ? imagePaths.light : imagePaths.dark}"
                                            alt="icon" width="50px" height="50px">
                                        &nbsp;&nbsp;&nbsp;&nbsp;${textValue}
                                        <img src="${isLightTheme ? "/static/images/delete_light.png" : "/static/images/delete_dark.png"}"
                                            alt="delete" width="50px" height="50px" class="delete-icon" data-id="${data.folderId}">
                                    `;
                                    folderList.replaceChild(newItem, inputItem);

                                    newItem.addEventListener('click', (event) => {
                                        if (event.target.classList.contains("delete-icon")) {
                                            return; // 삭제 버튼 클릭 시 folder-item의 이벤트 실행 차단
                                        }
                                        
                                        // 새 폴더 버튼은 해당 안하니까 패스
                                        const backBtn = document.getElementById('backBtn');
                                        const backbookmarkTitleBtn = document.getElementById('bookmark_title');
                                        const placeBtn = document.getElementById('placeBtn');
                                        const scheduleBtn = document.getElementById('scheduleBtn');
                                        const topmenu = document.querySelector('.top-menu');
                                        const AllFolderLists = favoritesPanel.querySelectorAll('.folder-list');
                                        const bookmarkPlaceItemDiv = document.querySelector(".bookmark-place-item");
                                        const bookmarkScheduleItemDiv = document.querySelector(".bookmark-schedule-item");
                                        
                                        if (AllFolderLists) {
                                            AllFolderLists.forEach(folderList => {
                                                folderList.style.display = "none";
                                            });
                                        }
                                        
                                        topmenu.style.justifyContent = "start";
                                        backBtn.style.display = "block";
                                        backbookmarkTitleBtn.style.display = "block";
                                        backbookmarkTitleBtn.textContent = newItem.textContent.trim().replace(/\s{2,}/g, '').replace(/\u00a0+/g, '');
                                        placeBtn.style.display = "none";
                                        scheduleBtn.style.display = "none";

                                        // bookmark-place-item과 bookmark-schedule-item 초기화
                                        if (bookmarkPlaceItemDiv) {                            
                                            bookmarkPlaceItemDiv.style.display = "none";
                                            bookmarkPlaceItemDiv.innerHTML = ""; // 기존 자식 요소 제거
                                        }
                                        if (bookmarkScheduleItemDiv) {
                                            bookmarkScheduleItemDiv.style.display = "none";
                                            bookmarkScheduleItemDiv.innerHTML = ""; // 기존 자식 요소 제거
                                        }
                                        
                                        // const bookmarkId = this.id; // 클릭된 div의 ID 가져오기
                                        // if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                        //     return; // "새 폴더" 버튼 클릭 시 무시
                                        // }

                                        // try {
                                        //     // 서버에 bookmark_id로 데이터 요청
                                        //     const response = await fetch(`/app/partials/favorites/get_bookmark_items/${bookmarkId}/`, {
                                        //         method: "GET",
                                        //         headers: {
                                        //             "Content-Type": "application/json",
                                        //         },
                                        //     });

                                        //     if (!response.ok) {
                                        //         throw new Error(`HTTP error! status: ${response.status}`);
                                        //     }

                                        //     const data = await response.json();
                                        //     if (data.type === "place") {
                                        //         // 장소 즐겨찾기
                                        //         if (bookmarkPlaceItemDiv) {
                                        //             bookmarkPlaceItemDiv.style.display = "block";

                                        //             data.rows.forEach(row => {
                                        //                 const itemDiv = document.createElement("div");
                                        //                 itemDiv.className = "place-item";
                                        //                 itemDiv.id = row.id;
                                        //                 itemDiv.innerHTML = `
                                        //                     <p style="display: flex; align-items: center;"><strong>이름:</strong> ${row.name}</p>
                                        //                 `;
                                        //                 itemDiv.addEventListener("click", async () => {
                                        //                     //DB에서 해당 데이터 불러오기
                                        //                     document.querySelectorAll(".place-item").forEach(folder => {                                                
                                        //                         folder.style.backgroundColor = ""; // 원래 색으로 복원 (CSS 초기값)
                                        //                     });
                                        //                     document.getElementById("getBookmarkListBtn").textContent = "★";
                                        //                     itemDiv.style.backgroundColor = "#999";

                                        //                     const bookmarkId = this.id; // folder-item의 ID 값
                                        //                     if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                        //                         return; // "새 폴더" 버튼은 클릭 이벤트 무시
                                        //                     }

                                        //                     try {
                                        //                         // 서버에 bookmark_id로 데이터 요청
                                        //                         const response = await fetch(`/app/partials/favorites/bookmark-place-detail/${row.id}/`, {
                                        //                             method: "GET",
                                        //                             headers: {
                                        //                                 "Content-Type": "application/json",
                                        //                             },
                                        //                         });

                                        //                         if (!response.ok) {
                                        //                             throw new Error(`HTTP error! status: ${response.status}`);
                                        //                         }
                                                                
                                        //                         // UI 업데이트: map-panel-content 또는 다른 요소에 데이터 표시
                                        //                         const data = await response.json(); // JSON 응답 파싱
                                        //                         const mapPanelContent = document.querySelector(".map-panel-content");
                                        //                         if (!mapPanelContent) {
                                        //                             console.error("map-panel-content element not found");
                                        //                             return;
                                        //                         }

                                        //                         // 기존 내용 제거
                                        //                         mapPanelContent.innerHTML = "";

                                        //                         // 장소 정보 표시
                                        //                         if (data) {
                                        //                             const panelTitle = document.getElementById("panel-title");
                                        //                             panelTitle.innerHTML = `${row.name}`;
                                        //                             const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                        //                             getBookmarkListBtn.classList.remove("schedule");
                                        //                             getBookmarkListBtn.classList.add("place");
                                        //                             getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                        //                             const placeSection = document.createElement("div");
                                        //                             placeSection.className = "place-section";
                                        //                             placeSection.innerHTML = `
                                        //                                 <h3>장소 정보</h3>
                                        //                                 <p><strong>이름:</strong> ${data.name}</p>
                                        //                                 <p><strong>주소:</strong> ${data.address}</p>
                                        //                                 <p><strong>설명:</strong> ${data.description || "설명이 없습니다."}</p>
                                        //                             `;
                                        //                             mapPanelContent.appendChild(placeSection);
                                        //                         } else {
                                        //                             const noDataMessage = document.createElement("p");
                                        //                             noDataMessage.textContent = "해당 데이터가 없습니다.";
                                        //                             mapPanelContent.appendChild(noDataMessage);
                                        //                         }
                                        //                     } catch (error) {
                                        //                         console.error("Error fetching bookmark place data:", error);
                                        //                     }
                                        //                 });

                                        //                 // 삭제 버튼 추가
                                        //                 const deleteButton = document.createElement('img');
                                        //                 deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                        //                     ? '/static/images/delete_light.png' 
                                        //                     : '/static/images/delete_dark.png';
                                        //                 deleteButton.style.cursor = 'pointer';
                                        //                 deleteButton.style.marginLeft = 'auto';
                                        //                 deleteButton.style.marginRight = '10px';
                                        //                 deleteButton.style.opacity = '0.7';
                                        //                 deleteButton.width = 25;
                                        //                 deleteButton.height = 25;

                                        //                 // 삭제 버튼 이벤트 추가
                                        //                 deleteButton.addEventListener('click', (event) => {
                                        //                     event.stopPropagation();
                                        //                     // UI에서 제거
                                        //                     bookmarkPlaceItemDiv.removeChild(itemDiv);

                                        //                     //DB에서도 해당 데이터 제거

                                        //                 });

                                        //                 deleteButton.addEventListener('mouseover', () => {
                                        //                     deleteButton.style.opacity = '1.0';
                                        //                 });

                                        //                 deleteButton.addEventListener('mouseleave', () => {
                                        //                     deleteButton.style.opacity = '0.7';
                                        //                 });

                                        //                 itemDiv.appendChild(deleteButton);
                                        //                 bookmarkPlaceItemDiv.appendChild(itemDiv);
                                        //             });
                                        //         }
                                        //     } 
                                        //     else if (data.type === "schedule") {
                                        //         // 일정 즐겨찾기
                                        //         if (bookmarkScheduleItemDiv) {
                                        //             bookmarkScheduleItemDiv.style.display = "block";

                                        //             data.rows.forEach(row => {
                                        //                 const itemDiv = document.createElement("div");
                                        //                 itemDiv.className = "schedule-item";
                                        //                 itemDiv.id = row.id;
                                        //                 itemDiv.innerHTML = `
                                        //                     <p style="display: flex; align-items: center;"><strong>이름:</strong> ${row.name}</p>
                                        //                 `;
                                        //                 itemDiv.addEventListener("click", async () => {
                                        //                     document.querySelectorAll(".schedule-item").forEach(folder => {                                                
                                        //                         folder.style.backgroundColor = ""; // 원래 색으로 복원 (CSS 초기값)
                                        //                     });

                                        //                     document.getElementById("getBookmarkListBtn").textContent = "★";
                                        //                     itemDiv.style.backgroundColor = "#999";

                                        //                     const bookmarkId = this.id; // folder-item의 ID 값
                                        //                     if (!bookmarkId || bookmarkId === "plus-place" || bookmarkId === "plus-schedule") {
                                        //                         return; // "새 폴더" 버튼은 클릭 이벤트 무시
                                        //                     }

                                        //                     try {
                                        //                         // 서버에 bookmark_id로 데이터 요청
                                        //                         const response = await fetch(`/app/partials/favorites/bookmark-schedule-detail/${row.id}/`, {
                                        //                             method: "GET",
                                        //                             headers: {
                                        //                                 "Content-Type": "application/json",
                                        //                             },
                                        //                         });

                                        //                         if (!response.ok) {
                                        //                             throw new Error(`HTTP error! status: ${response.status}`);
                                        //                         }

                                        //                         // UI 업데이트: map-panel-content 또는 다른 요소에 데이터 표시
                                        //                         const data = await response.json(); // JSON 응답 파싱
                                        //                         const mapPanelContent = document.querySelector(".map-panel-content");
                                        //                         if (!mapPanelContent) {
                                        //                             console.error("map-panel-content element not found");
                                        //                             return;
                                        //                         }

                                        //                         // 기존 내용 제거
                                        //                         mapPanelContent.innerHTML = "";

                                        //                         // 일정 정보 표시
                                        //                         if (data) {;
                                        //                             const panelTitle = document.getElementById("panel-title");
                                        //                             panelTitle.innerHTML = `${row.name}`;
                                        //                             const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
                                        //                             getBookmarkListBtn.classList.remove("place");
                                        //                             getBookmarkListBtn.classList.add("schedule");
                                        //                             getBookmarkListBtn.setAttribute("bookmark_id", row.bookmark);
                                        //                             const jsonData = JSON.parse(data.json_data);
                                        //                             generateDayButtons(jsonData);
                                        //                             generateDynamicPlanContent(jsonData);
                                        //                         } else {
                                        //                             const noDataMessage = document.createElement("p");
                                        //                             noDataMessage.textContent = "해당 데이터가 없습니다.";
                                        //                             mapPanelContent.appendChild(noDataMessage);
                                        //                         }
                                        //                     } catch (error) {
                                        //                         console.error("Error fetching bookmark place data:", error);
                                        //                     }
                                        //                 });

                                        //                 // 삭제 버튼 추가
                                        //                 const deleteButton = document.createElement('img');
                                        //                 deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                        //                     ? '/static/images/delete_light.png' 
                                        //                     : '/static/images/delete_dark.png';
                                        //                 deleteButton.style.cursor = 'pointer';
                                        //                 deleteButton.style.marginLeft = 'auto';
                                        //                 deleteButton.style.marginRight = '10px';
                                        //                 deleteButton.style.opacity = '0.7';
                                        //                 deleteButton.width = 25;
                                        //                 deleteButton.height = 25;

                                        //                 // 삭제 버튼 이벤트 추가
                                        //                 deleteButton.addEventListener('click', (event) => {
                                        //                     event.stopPropagation();
                                        //                     // UI에서 제거  
                                        //                     itemDiv.remove();

                                        //                     //DB에서도 해당 데이터 제거

                                        //                 });

                                        //                 deleteButton.addEventListener('mouseover', () => {
                                        //                     deleteButton.style.opacity = '1.0';
                                        //                 });

                                        //                 deleteButton.addEventListener('mouseleave', () => {
                                        //                     deleteButton.style.opacity = '0.7';
                                        //                 });

                                        //                 itemDiv.appendChild(deleteButton);
                                        //                 bookmarkScheduleItemDiv.appendChild(itemDiv);
                                        //             });
                                        //         }
                                        //     }
                                        //     else {
                                        //         console.log("No data found");
                                        //     }
                                        // } catch (error) {
                                        //     console.error("Error fetching bookmark data:", error);
                                        // }
                                    })
                                    attachDeleteEvent(newItem); // 삭제 이벤트 연결
                                    updateFolderListUI(folderList, plusElement);

                                    console.log("생성 성공:", data.folderId);
                                } else {
                                    alert("생성 실패: " + (data.error || "알 수 없는 오류"));
                                    folderList.removeChild(inputItem);
                                }
                            })
                            .catch((err) => {
                                console.error("서버 통신 오류:", err);
                                folderList.removeChild(inputItem);
                            });
                        }
                    });
                });
            }
        }

        // 네이버 Geocoding API를 통해 경도와 위도를 가져오는 함수
        async function getCoordinates(addresses) {
            if (!Array.isArray(addresses)) {
                console.error("Addresses must be an array.");
                return [];
            }
            const markerData = [];
            const promises = addresses.map(async ({ address, title }) => {
                if (!address) return; // address가 없는 경우 건너뜀

                const coordinates = await fetchCoordinates(address);
                if (coordinates) {
                    const [lat, lng] = coordinates;
                    markerData.push({
                        position: new naver.maps.LatLng(lat, lng),
                        title: title,
                        icon: `https://chart.googleapis.com/chart?chst=d_map_pin_number&chld=${markerData.length + 1}|FF0000|000000`,
                    });
                }
            });

            await Promise.all(promises); // 모든 비동기 작업이 완료될 때까지 대기
            return markerData;
        }

        async function generateDynamicPlanContent(jsonData) {
            const mapPanelContent = document.querySelector('.map-panel-content');
            //터미널에 추가된 내용이 스케줄이라는 것을 체크하기 위함
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            getBookmarkListBtn.classList.remove("place");
            getBookmarkListBtn.classList.add("schedule");
            if (!mapPanelContent) {
                console.error('map-panel-content 요소를 찾을 수 없습니다.');
                return;
            }

            // 마커 데이터를 저장하는 배열
            let markerData = [];

            async function renderDayContent(day) {
                // JSON 데이터에서 주소 정보 추출
                const addresses = [];
                Object.keys(day.meals).forEach(mealType => {
                    const mealData = day.meals[mealType];
                    if (mealData.식사장소 && mealData.식사장소.주소) {
                        addresses.push({
                            address: mealData.식사장소.주소,
                            title: mealData.식사장소.장소 || `${mealType} 식사장소`
                        });
                    }
                    if (mealData.명소 && mealData.명소.명소위치) {
                        addresses.push({
                            address: mealData.명소.명소위치,
                            title: mealData.명소.명소이름 || `${mealType} 명소`
                        });
                    }
                });

                // 지도 내용 초기화
                mapPanelContent.innerHTML = '';
                const planContent = document.createElement('div');
                planContent.className = 'plan-content';
                mapPanelContent.appendChild(planContent);

                Object.keys(day.meals).forEach(mealType => {
                    const mealData = day.meals[mealType];
                    const mealSection = document.createElement('div');
                    mealSection.className = 'meal-section';
                    mealSection.innerHTML = `<h4>${mealType}</h4>`;

                    Object.keys(mealData).forEach(section => {
                        const sectionData = mealData[section];
                        if (sectionData) {
                            const name = sectionData["장소"] || sectionData["명소이름"];
                            const address = sectionData["주소"] || sectionData["명소위치"];
                            const overview = sectionData["음식점특징"] || sectionData["명소특징"];

                            if (name && address) {
                                const listItem = document.createElement('p');
                                listItem.innerHTML = `<strong>${name}</strong> (${address})`;

                                const buttonContainer = document.createElement('div');
                                buttonContainer.className = "button-container";
                                buttonContainer.setAttribute('overview', overview);
                                buttonContainer.setAttribute('address', address);
                                buttonContainer.style.display = 'inline-flex';
                                buttonContainer.style.alignItems = 'center';
                                buttonContainer.style.flexWrap = "nowrap";

                                // 즐겨찾기 등록 버튼 추가
                                const bookmarkButton = document.createElement('button');
                                bookmarkButton.style.cursor = 'pointer';
                                bookmarkButton.style.marginLeft = '5px';
                                bookmarkButton.style.border = "none";
                                bookmarkButton.textContent = "☆";
                                bookmarkButton.style.justifyContent = "center";
                                bookmarkButton.addEventListener('click', () => {
                                    getBookmarkList("true", `${name}`, `${address}`);
                                });

                                // 삭제 버튼 추가
                                const deleteButton = document.createElement('img');
                                deleteButton.id = "deletePlaceBtn";
                                deleteButton.src = document.body.getAttribute('data-theme') === 'light' 
                                    ? '/static/images/delete_light.png' 
                                    : '/static/images/delete_dark.png';
                                deleteButton.style.cursor = 'pointer';
                                deleteButton.width = 16;
                                deleteButton.height = 16;
                                deleteButton.style.display = "inline-flex"; // Flexbox에 적합
                                deleteButton.style.alignItems = "center";
                                deleteButton.style.justifyContent = "center";

                                // 삭제 버튼 이벤트 추가
                                deleteButton.addEventListener('click', () => {
                                    // UI에서 제거
                                    mealSection.removeChild(listItem);

                                    // JSON 데이터에서 해당 항목 제거
                                    if (section === "식사장소") {
                                        delete mealData[section];
                                    } else if (section === "명소") {
                                        delete mealData[section];
                                    }

                                    // 전역 markerData에서 해당 마커 제거
                                    globalMarkerData = globalMarkerData.filter(marker => marker.title !== name);

                                    // 지도 업데이트
                                    addMarkersToMap(globalMarkerData);

                                    // 디버깅용 로그
                                    console.log("Updated globalMarkerData:", globalMarkerData);
                                    console.log("Updated JSON data:", day);
                                });

                                buttonContainer.appendChild(bookmarkButton);
                                buttonContainer.appendChild(deleteButton);
                                listItem.appendChild(buttonContainer);
                                mealSection.appendChild(listItem);
                            }
                        }
                    });

                    planContent.appendChild(mealSection);
                });

                // 주소로 마커 데이터 생성
                try {
                    globalMarkerData = await getCoordinates(addresses); // 전역 변수 업데이트
                    addMarkersToMap(globalMarkerData); // 지도 업데이트
                } catch (error) {
                    console.error("Error generating marker data:", error);
                }
            }


            // 버튼 생성 및 이벤트 바인딩
            generateDayButtons(jsonData, (day) => {
                markerData = []; // 새로운 일차 선택 시 기존 마커 데이터 초기화
                console.log("Day object passed to renderDayContent:", day);
                renderDayContent(day); // 선택된 일차의 데이터 렌더링
            });
        }

        function generateDayButtons(jsonData, renderDayContentCallback) {
            const mapPanel = document.getElementById('map-panel');
            if (!mapPanel) {
                console.error('map-panel 요소를 찾을 수 없습니다.');
                return;
            }

            let buttonContainer = document.getElementById('day-button-container');
            if (!buttonContainer) {
                buttonContainer = document.createElement('div');
                buttonContainer.id = 'day-button-container';
                buttonContainer.style.position = 'absolute';
                buttonContainer.style.top = `${mapPanel.getBoundingClientRect().top - 50}px`;
                buttonContainer.style.left = '40px';
                buttonContainer.style.display = 'flex';
                buttonContainer.style.gap = '10px';
                buttonContainer.style.zIndex = '100';

                const mapContainer = document.getElementById('map-container');
                if (mapContainer) {
                    mapContainer.appendChild(buttonContainer);
                } else {
                    console.error('map-container 요소를 찾을 수 없습니다.');
                    return;
                }
            } else {
                buttonContainer.innerHTML = ''; // 기존 버튼 초기화
            }

            console.log("jsonData:", jsonData);
            console.log("1typeof jsonData:", typeof jsonData);
            if (typeof jsonData === "string") {
                jsonData = JSON.parse(jsonData);
                console.log("2typeof jsonData:", typeof jsonData);
            }
            console.log("3typeof jsonData:", typeof jsonData);
            
            let firstButton = null;
            jsonData.forEach((day, index) => {
                const dayButton = document.createElement('button');
                dayButton.textContent = `${day.day}일차`;
                dayButton.style.padding = '8px 16px';
                dayButton.style.border = 'none';
                dayButton.style.borderRadius = '20px';
                dayButton.style.backgroundColor = '#ddd';
                dayButton.style.cursor = 'pointer';

                dayButton.addEventListener('click', () => {
                    const allButtons = buttonContainer.querySelectorAll('button');
                    allButtons.forEach(btn => (btn.style.backgroundColor = '#ddd'));
                    dayButton.style.backgroundColor = 'white';

                    if (typeof renderDayContentCallback === 'function') {
                        renderDayContentCallback(day);
                    }
                });

                if (index === 0) {
                    firstButton = dayButton;
                }

                buttonContainer.appendChild(dayButton);
            });

            if (firstButton) {
                firstButton.click();
            } else {
                console.error('생성된 버튼이 없습니다.');
            }
        }

        function addMarkersToMap(markerData) {
            console.log("markerData:", markerData);
            if (!map || !isMapInitialized) {
                console.error("Map is not initialized yet!");
                return;
            }
            
            // 기존 마커 제거
            if (window.currentMarkers) {
                window.currentMarkers.forEach(marker => marker.setMap(null));
            }
            window.currentMarkers = []; // 새로운 마커 배열 초기화

            // 기존 선 제거
            if (window.currentPolylines) {
                window.currentPolylines.forEach(polyline => polyline.setMap(null));
            }
            window.currentPolylines = []; // 새로운 선 배열 초기화

            // 새 마커 추가
            markerData.forEach(data => {
                const marker = new naver.maps.Marker({
                    position: data.position,
                    map: map,
                    title: data.title,
                    icon: {
                        url: data.icon,
                        size: new naver.maps.Size(36, 36), // 마커 크기
                        origin: new naver.maps.Point(0, 0),
                        anchor: new naver.maps.Point(18, 36), // 마커 위치 조정
                    },
                });

                // 정보창 생성
                // var infoWindow = new naver.maps.InfoWindow({
                //     content: `<div style="width:100px;text-align:center;padding:10px;">
                //                 <h4>가맹점 정보</h4>
                //                 <p>여기에 가맹점 정보를 표시합니다.</p>
                //             </div>`
                // });

                // 마커 클릭 이벤트 (선택 사항)
                naver.maps.Event.addListener(marker, 'click', function () {
                    alert(`${data.title}입니다!`);
                    //infoWindow.open(map, marker); // 마커 클릭 시 정보창 열기
                });

                // 현재 마커를 전역 배열에 저장
                window.currentMarkers.push(marker);
            });

            // 새 선 추가
            if (markerData.length > 1) {
                for (let i = 0; i < markerData.length - 1; i++) {
                    const polyline = new naver.maps.Polyline({
                        map: map,
                        path: [markerData[i].position, markerData[i + 1].position], // 인접한 마커 연결
                        strokeColor: '#000000', // 선 색상
                        strokeWeight: 0, // 선 두께
                        strokeStyle: 'solid', // 선 스타일 (solid, dashed, dotted 등)
                    });

                    // 현재 선을 전역 배열에 저장
                    window.currentPolylines.push(polyline);
                }
            }

            // 지도 범위를 업데이트
            if (markerData.length > 0) {
                const bounds = new naver.maps.LatLngBounds();
                markerData.forEach(marker => bounds.extend(marker.position));
                map.fitBounds(bounds, { top: 50, right: 50, bottom: 50, left: 50 });
            }
        }

        async function fetchCoordinates(address) {
            // Proxy API 엔드포인트 URL 설정 (Django 백엔드의 엔드포인트 예시)
            const url = `http://127.0.0.1:8000/proxy/geocode/?address=${encodeURIComponent(address)}`;

            try {
                const response = await fetch(url); // Fetch 요청 전송
                if (!response.ok) {
                    throw new Error(`Failed to fetch: ${response.status}`);
                }
                const data = await response.json(); // JSON 응답 파싱

                // 좌표 데이터를 반환
                if (data.addresses && data.addresses.length > 0) {
                    const { x: lng, y: lat } = data.addresses[0]; // x: 경도, y: 위도
                    return [parseFloat(lat), parseFloat(lng)];
                } else {
                    console.error(`No valid coordinates found for address: ${address}`, data);
                    return null;
                }
            } catch (error) {
                console.error(`Error fetching coordinates for ${address}:`, error);
                return null;
            }
        }

        async function getBookmarkList(is_place="", name=``, address=``) {
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            const isSchedule = getBookmarkListBtn.classList.contains("schedule"); // 장소인지 확인
            const bookmarkID = getBookmarkListBtn.getAttribute("bookmark_id");
            let isPlace = getBookmarkListBtn.classList.contains("place"); // 장소인지 확인

            if (is_place) {
                isPlace = is_place;
            }

            if (isPlace || isSchedule) {               
                try {
                    const response = await fetch(`/app/partials/favorites/get_bookmark/?is_place=${isPlace}`, {
                        method: "GET",
                        headers: {
                            "Content-Type": "application/json",
                        },
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP error! status: ${response.status}`);
                    }

                    const data = await response.json();
                    if (data.success) {                        
                        let innerHtml = "";                        
                        const bookmarklistPanel = document.querySelector('.bookmarklist-panel ul');                        
                        const title = document.querySelector(".bookmarklist-panel h2");
                        const addressTitle = document.querySelector(".bookmarklist-panel h3");
                        const changeTitle = document.getElementById("change-title")
                        const panelTitle = document.querySelector("#panel-title");
                        bookmarklistPanel.innerHTML = "";

                        if (isPlace) {          
                            //장소 이름을 그대로 제목으로 짓기
                            if (address) {
                                addressTitle.textContent = address;
                            }
                            else if (document.querySelectorAll(".place-section p")[1]) {
                                addressTitle.textContent = document.querySelectorAll(".place-section p")[1].textContent.split(": ")[1];
                            }
                            // else { // 채팅 내역에서 장소를 즐겨찾기 등록하는 케이스
                            // }
                            if (name) {
                                title.textContent = name;
                            }
                            else if (document.querySelector("#panel-title").textContent.trim()) {
                                title.textContent = document.querySelector("#panel-title").textContent.trim();
                            }
                            // else { // 채팅 내역에서 장소를 즐겨찾기 등록하는 케이스
                            // } 
                            title.addEventListener("dblclick", function () {
                                changeTitle.value = title.textContent;
                                changeTitle.style.display = "block"; // 입력창 표시
                                title.style.display = "none"; // 기존 텍스트 숨김
                                changeTitle.focus();
                            });

                            // 2) Enter: 제목 저장, ESC: 취소
                            changeTitle.addEventListener("keydown", async function (e) {
                                if (event.key === "Enter") {
                                    const newTitle = changeTitle.value.trim();
                                    
                                    if (!newTitle) {
                                        alert("제목을 입력해주세요.");
                                        return;
                                    }
                                    
                                    title.textContent = newTitle;
                                    title.style.display = "block"; // 기존 텍스트 표시
                                    changeTitle.style.display = "none"; // 입력창 숨김
                                } 
                                else if (event.key === "Escape") {
                                    title.style.display = "block"; // 기존 텍스트 표시
                                    changeTitle.style.display = "none";  // 입력창 숨김
                                }                    
                            });
                        }
                        else if (isSchedule) {
                            //일정 이름은 (일정 + 시간)으로 짓기  (예:일정250120102730)
                            // title.textContent = "";
                            if (panelTitle.textContent == "") {
                                // 현재 시각 포맷팅
                                const now = new Date();
                                const year = String(now.getFullYear()).slice(2); // 연도 마지막 두 자리
                                const month = String(now.getMonth() + 1).padStart(2, "0"); // 월 (1~12)
                                const day = String(now.getDate()).padStart(2, "0"); // 일
                                const hours = String(now.getHours()).padStart(2, "0"); // 시간 (0~23)
                                const minutes = String(now.getMinutes()).padStart(2, "0"); // 분
                                const seconds = String(now.getSeconds()).padStart(2, "0"); // 초
                                const milliseconds = now.getTime();
                                // const curDate = `${year}.${month}.${day} ${hours}:${minutes}:${seconds}`;
                                const curDate = `${milliseconds.toString(16)}`;
                                title.textContent = "일정 " + curDate;
                            }
                            else {
                                title.textContent = panelTitle.textContent;
                            }
                        } 

                        //기존 즐겨찾기 항목 버튼들 추가
                        data.bookmarks.forEach(bookmark => {
                                const createLi = document.createElement('li');                            
                                const milliseconds = new Date(bookmark['created_at']).getTime();
                                const colorValue = milliseconds % 0xFFFFFF; 
                                const hexColor = `#${colorValue.toString(16).padStart(6, '0')}`;
                                createLi.className = "bookmark_item";
                                createLi.id = bookmark['id'];
                                createLi.style.cursor = "pointer";
                                innerHtml = `
                                    <div style="background-color: ${hexColor}">
                                        <span style="font-size: 17px; color: white;">★</span>
                                    </div>
                                    <p>${bookmark['title']}</p>
                                    <button>
                                        ${bookmarkID === bookmark['id'] 
                                            ? '<span style="font-size: 17px; color: #5454ea;">✔</span>' 
                                            : '<span style="font-size: 27px; color: white;">+</span>'
                                        }
                                    </button>
                                `;                            
                                createLi.innerHTML = innerHtml;
                                
                                createLi.addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('div').addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('span').addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('button').addEventListener('click', (event) => {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                createLi.querySelector('p').addEventListener('click', (event)=> {event.stopPropagation(); addToBookmark(createLi, createLi.querySelector('button span'), isPlace, name, address) });
                                bookmarklistPanel.appendChild(createLi);
                        });
                        
                        //새 즐겨찾기 항목 만드는 버튼 추가                        
                        const createLi = document.createElement('li');
                        createLi.className = "bookmark_item";
                        createLi.id = "add_bookmark_list_btn";   
                        innerHtml = `
                            <div>
                                <span>+</span>
                            </div>
                            <p>새 즐겨찾기 항목</p>
                        `;              

                        //10개 미만이면 활성화, 그 이상이면 비활성화 
                        if (bookmarklistPanel.childNodes.length < 10) {
                            createLi.addEventListener('click', () => {
                                if (document.querySelectorAll("#new-folder").length == 0) {
                                    const add_bookmark_list_btn = document.getElementById("add_bookmark_list_btn");
                                    const inputElem = document.createElement("input");
                                    inputElem.id = "new-folder";
                                    inputElem.type = "text";
                                    inputElem.placeholder = "새 폴더 이름 입력 (Enter)";
                                    inputElem.style.width = "200px";
                                    inputElem.style.marginBottom = "20px";

                                    const plusElement = document.querySelector(".bookmarklist-panel ul");
                                    plusElement.insertBefore(inputElem, add_bookmark_list_btn);

                                    inputElem.focus();

                                    // Enter로 확정
                                    inputElem.addEventListener("keydown", function (e) {
                                        if (e.key === "Enter") {
                                            e.preventDefault();
                                            const textValue = inputElem.value.trim();
                                            const isLightTheme = document.body.getAttribute("data-theme") === "light";

                                            // 입력이 없으면 취소
                                            if (textValue !== "") {
                                                const inputItem = document.querySelector(`.bookmarklist-panel .folder-item`);
                                                const items = document.querySelectorAll('.bookmarklist-panel ul li');                                                                             
                                                inputElem.remove();

                                                // 서버로 AJAX 호출
                                                fetch("/app/partials/favorites/add/", {
                                                    method: "POST",
                                                    headers: {
                                                        "Content-Type": "application/json",
                                                        "X-CSRFToken": getCSRFToken()
                                                    },
                                                    body: JSON.stringify({
                                                        title: textValue,
                                                        is_place: isPlace,
                                                    })
                                                })
                                                .then(response => {
                                                    if (!response.ok) {
                                                        throw new Error(`HTTP error! status: ${response.status}`);
                                                    }
                                                    return response.json();
                                                })
                                                .then((data) => {
                                                    if (data.success) {
                                                        const createLi = document.createElement('li');                            
                                                        const milliseconds = Date.now();
                                                        const colorValue = milliseconds % 0xFFFFFF; 
                                                        const hexColor = `#${colorValue.toString(16).padStart(6, '0')}`;
                                                        createLi.className = "bookmark_item";
                                                        createLi.id = data['id'];
                                                        innerHtml = `
                                                            <div style="background-color: ${hexColor}">
                                                                <span style="font-size: 17px; color: white;">★</span>
                                                            </div>
                                                            <p>${textValue}</p>
                                                            <button>
                                                                ${bookmarkID === data['folderId'] 
                                                                    ? '<span style="font-size: 17px; color: #5454ea;">✔</span>' 
                                                                    : '<span style="font-size: 27px; color: white;">+</span>'
                                                                }
                                                            </button>
                                                        `;                            
                                                        createLi.innerHTML = innerHtml;
                                                        console.log("whia:", document.querySelector('.bookmarklist-panel ul'));
                                                        document.querySelector('.bookmarklist-panel ul').insertBefore(createLi, add_bookmark_list_btn);
                                                    } else {
                                                        alert("생성 실패: " + (data.error || "알 수 없는 오류"));
                                                    }
                                                })
                                                .catch((err) => {
                                                    console.error("서버 통신 오류:", err);
                                                });
                                            }                                    
                                        }
                                    });
                                }

                                // addFolderEventHandler(
                                //     "plus-place",
                                //     "#placesSection",
                                //     "새 폴더 이름 입력 (Enter)",
                                //     true,
                                //     { light: "/static/images/folder_light.png", dark: "/static/images/folder_dark.png" }
                                // );
                            })
                            createLi.classList.remove("button_inactive");
                            createLi.classList.add("button_active");
                        }
                        else {
                            createLi.classList.remove("button_active");
                            createLi.classList.add("button_inactive");
                        }

                        createLi.innerHTML = innerHtml;
                        bookmarklistPanel.appendChild(createLi);
                        
                        toggleAnimation();                       
                    } 
                } catch (error) {
                    console.error("Error fetching bookmarks:", error);
                }
            }
            else {
                alert("즐겨찾기에 저장할 데이터가 없습니다.");
            }
        }

        function addClickEvent() {
            
        }

        async function deleteBookmarklist(row) {
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            try {
                const payload = {
                    bookmark_id: row.bookmark_id, // bookmark_id는 항상 포함
                };
                if (row.id.includes("pc")) {
                    payload.bookmarkplace_id = row.id;
                    if (row.id == getBookmarkListBtn.getAttribute("bookmarkplace_id")) {
                        removeContent();
                    }
                }
                if (row.id.includes("sc")) {
                    payload.bookmarkschedule_id = row.bookmarkschedule_id;
                    if (row.id == getBookmarkListBtn.getAttribute("bookmarkschedule_id")) {
                        removeContent();
                    }
                }
                const response = await fetch(`/app/partials/favorites/delete_bookmarklist/`, {
                    method: "POST", // POST 요청
                    headers: {
                        "Content-Type": "application/json", // JSON 데이터 전송
                    },
                    body: JSON.stringify(payload), // payload를 JSON으로 변환하여 본문에 추가
                });
            } catch (error) {
                console.error("Error fetching bookmarks:", error);
            }
        }

        function addToBookmark(li, span, isPlace, name, address) {
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            const panelTitle= document.getElementById("panel-title");
            const bookmarkId = li.id; 
            let body = null;
            let nameData = name || document.querySelector(".bookmarklist-panel h2").textContent;
            let addressData = address || document.querySelector(".bookmarklist-panel h3").textContent;

            if (isPlace) {
                // getBookmarkListBtn.classList.remove('place');
                body = JSON.stringify({
                    is_place: true,
                    name: nameData,
                    bookmark_id: bookmarkId,
                    bookmarkplace_id: getBookmarkListBtn.getAttribute("bookmarkplace_id"),
                    bookmarkschedule_id: null,
                    category: null,
                    longitude: null,
                    latitude: null,
                    address: addressData,
                    overview: getBookmarkListBtn.getAttribute("overview"),
                })
            }
            else {
                body = JSON.stringify({
                    is_place: false,
                    name: nameData,
                    bookmark_id: bookmarkId,
                    bookmarkplace_id: null,
                    bookmarkschedule_id: getBookmarkListBtn.getAttribute("bookmarkschedule_id"),
                    json_data: getBookmarkListBtn.getAttribute("json_data"),
                })
            }

            span.textContent = "✔";
            span.style.fontSize = "17px";
            span.style.color = "#5454ea";

            fetch("/app/partials/favorites/add_bookmarklist/", {
                method: "POST",
                headers: {
                    "Content-Type": "application/json",
                    "X-CSRFToken": getCSRFToken(), // Django CSRF 토큰 필요
                },
                body: body,
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    console.log("Bookmark list added successfully!");
                } else {
                    console.error("Error:", data.error || data.message);
                }
            })
            .catch(error => {
                console.error("Error:", error);
            });
        }

        function removeContent() {
            const map_panel_content = document.querySelector(".map-panel-content");
            const getBookmarkListBtn = document.getElementById("getBookmarkListBtn");
            const panelTitle= document.getElementById("panel-title");
            getBookmarkListBtn.classList.remove('place');
            getBookmarkListBtn.classList.remove('schedule');
            getBookmarkListBtn.setAttribute("bookmark_id", null);
            getBookmarkListBtn.setAttribute("bookmarkplace_id", null);
            getBookmarkListBtn.setAttribute("bookmarkschedule_id", null);
            getBookmarkListBtn.setAttribute("json_data", null);
            getBookmarkListBtn.textContent = "☆";

            panelTitle.innerHTML = "";
            map_panel_content.innerHTML = "";

        }

        function toggleMapPanel() {
            const minHeight = 45; // 터미널 최소 높이
            const maxHeight = window.innerHeight / 2; // 터미널 최대 높이
            const toggleUIBtn = document.getElementById("toggleUIBtn");
            const mapPanel = document.getElementById("map-panel");
            const buttonContainer = document.getElementById("day-button-container");

            // transition 적용
            mapPanel.style.transition = "height 0.5s ease";

            // 터미널 높이 및 버튼 상태 변경
            if (toggleUIBtn.textContent === "⮝") {
                // 터미널 확장
                mapPanel.style.height = `${maxHeight}px`;
                toggleUIBtn.textContent = "⮟";
                console.log("UI restored");
            } else {
                // 터미널 축소
                mapPanel.style.height = `${minHeight}px`;
                toggleUIBtn.textContent = "⮝";
                console.log("UI hidden");
            }

            // 버튼 컨테이너 위치 업데이트
            if (buttonContainer) {
                buttonContainer.style.transition = "top 0.5s ease"; // 부드럽게 이동
                const mapPanelHeight = parseInt(mapPanel.style.height, 10);
                const mapPanelTop = window.innerHeight - mapPanelHeight; // mapPanel의 상단 위치 계산
                buttonContainer.style.top = `${mapPanelTop - buttonContainer.offsetHeight - 15}px`; // 터미널 위로 15px
            }

            // transition 제거 (500ms 후)
            setTimeout(() => {
                mapPanel.style.transition = "none";
                if (buttonContainer) {
                    buttonContainer.style.transition = "none";
                }
            }, 500); // transition 시간과 동일하게 설정
        }


        function toggleAnimation() {
            const animatedDiv = document.getElementById('bookmarklist-div');
            if (animatedDiv.classList.contains('active')) {
                // 활성화 상태이면 숨김
                animatedDiv.classList.remove('active');
            } else {
                // 비활성화 상태이면 나타냄
                animatedDiv.classList.add('active');
            }
        }
    </script>
</body>
</html>
